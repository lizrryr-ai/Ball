<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BALL BATTLE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap');

  :root {
    --p1: #00e5ff;
    --p2: #ff4444;
    --bg: #0a0a0f;
    --panel: #111118;
    --border: #222233;
    --gold: #ffd700;
    --nuke-color: #ff6b00;
    --doge-color: #00ff88;
    --world-color: #cc44ff;
    --mih-color: #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 1000;
  }

  /* ===== MAIN MENU ===== */
  #page-menu {
    background: radial-gradient(ellipse at 50% 0%, #1a0033 0%, var(--bg) 60%);
    gap: 20px;
  }

  .menu-btns {
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    margin-top: 10px;
  }

  .menu-btn {
    width: 300px;
    padding: 20px 40px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 5px;
    border: 2px solid;
    background: transparent;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .menu-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .menu-btn-sp {
    border-color: var(--p1);
    color: var(--p1);
    box-shadow: 0 0 15px rgba(0,229,255,0.2);
  }
  .menu-btn-sp:hover { background: var(--p1); color: #000; box-shadow: 0 0 40px rgba(0,229,255,0.5); transform: scale(1.05); }

  .menu-btn-mp {
    border-color: var(--p2);
    color: var(--p2);
    box-shadow: 0 0 15px rgba(255,68,68,0.2);
  }
  .menu-btn-mp:hover { background: var(--p2); color: #fff; box-shadow: 0 0 40px rgba(255,68,68,0.5); transform: scale(1.05); }

  .menu-desc {
    font-size: 12px;
    letter-spacing: 2px;
    color: #555;
    text-transform: uppercase;
    margin-top: -10px;
    text-align: center;
  }

  /* ===== MULTIPLAYER PAGE ===== */
  #page-mp {
    background: radial-gradient(ellipse at 50% 0%, #1a0010 0%, var(--bg) 60%);
    gap: 20px;
  }

  .mp-container {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 10px;
  }

  .mp-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 30px 36px;
    text-align: center;
    min-width: 260px;
    max-width: 320px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 14px;
    position: relative;
    overflow: hidden;
  }

  .mp-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .mp-card-create::before { background: var(--p1); box-shadow: 0 0 15px var(--p1); }
  .mp-card-join::before   { background: var(--p2); box-shadow: 0 0 15px var(--p2); }

  .mp-card-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 4px;
  }
  .mp-card-create .mp-card-title { color: var(--p1); }
  .mp-card-join   .mp-card-title { color: var(--p2); }

  .mp-card-emoji { font-size: 48px; }

  .mp-card-desc {
    font-size: 13px;
    color: #666;
    letter-spacing: 1px;
    line-height: 1.6;
  }

  .mp-action-btn {
    padding: 14px 20px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 4px;
    background: transparent;
    border: 2px solid;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mp-card-create .mp-action-btn { border-color: var(--p1); color: var(--p1); }
  .mp-card-create .mp-action-btn:hover { background: var(--p1); color: #000; box-shadow: 0 0 30px rgba(0,229,255,0.4); }

  .mp-card-join .mp-action-btn { border-color: var(--p2); color: var(--p2); }
  .mp-card-join .mp-action-btn:hover { background: var(--p2); color: #fff; box-shadow: 0 0 30px rgba(255,68,68,0.4); }

  .back-btn {
    padding: 10px 30px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    background: transparent;
    border: 1px solid #333;
    color: #555;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .back-btn:hover { border-color: #666; color: #aaa; }

  /* Room code display */
  .room-code-box {
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.3);
    border-radius: 8px;
    padding: 14px;
    display: none;
  }
  .room-code-box.show { display: block; }
  .room-code-label { font-size: 11px; letter-spacing: 3px; color: #666; text-transform: uppercase; margin-bottom: 6px; }
  .room-code-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 8px;
    color: var(--p1);
    text-shadow: 0 0 20px rgba(0,229,255,0.5);
  }
  .room-code-status { font-size: 12px; color: #555; margin-top: 6px; letter-spacing: 2px; animation: blink 1s ease-in-out infinite; }

  /* Join room input */
  .join-input-wrap {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .join-code-input {
    background: #0d0d18;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 6px;
    color: var(--p2);
    text-align: center;
    outline: none;
    text-transform: uppercase;
    transition: border-color 0.2s;
  }
  .join-code-input:focus { border-color: var(--p2); box-shadow: 0 0 10px rgba(255,68,68,0.2); }
  .join-code-input.error { border-color: #ff4444; animation: shakeDigit 0.3s ease; }
  .join-error-msg { font-size: 12px; color: #ff4444; letter-spacing: 1px; text-align: center; min-height: 16px; }

  /* MP Waiting page */
  #page-mp-wait {
    background: radial-gradient(ellipse at 50% 50%, #0d0020 0%, var(--bg) 60%);
    gap: 16px;
    text-align: center;
  }

  .wait-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 5px;
    color: #fff;
  }

  .wait-code {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 72px;
    letter-spacing: 12px;
    color: var(--p1);
    text-shadow: 0 0 30px rgba(0,229,255,0.5);
  }

  .wait-label { font-size: 12px; letter-spacing: 3px; color: #555; text-transform: uppercase; }

  .wait-dots::after {
    content: '';
    animation: dotAnim 1.5s steps(4, end) infinite;
  }
  @keyframes dotAnim {
    0%  { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
  }

  .wait-status {
    font-size: 14px;
    letter-spacing: 2px;
    color: #666;
    animation: blink 1.2s ease-in-out infinite;
  }

  .wait-player-status {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 10px;
  }

  .wait-player-slot {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 24px;
    min-width: 140px;
    text-align: center;
  }

  .wait-player-slot.ready {
    border-color: #00ff44;
    box-shadow: 0 0 15px rgba(0,255,68,0.2);
  }

  .wait-slot-label { font-size: 11px; letter-spacing: 2px; color: #555; text-transform: uppercase; }
  .wait-slot-status { font-family: 'Bebas Neue', sans-serif; font-size: 22px; margin-top: 4px; }
  .wait-player-slot.ready .wait-slot-status { color: #00ff44; }
  .wait-player-slot:not(.ready) .wait-slot-status { color: #333; animation: blink 1s ease-in-out infinite; }


  /* ============================================================
     NEW TWO-PAGE SELECT LAYOUT
  ============================================================ */
  .page { display: none; min-height: 100vh; }
  .page.active { display: flex; flex-direction: column; }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  @keyframes titlePulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3)} }
  @keyframes floatEmoji { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }

  .game-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(48px, 8vw, 96px);
    text-align: center;
    letter-spacing: 8px;
    background: linear-gradient(90deg, var(--p1), #fff, var(--p2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titlePulse 3s ease-in-out infinite;
  }
  .subtitle {
    text-align: center;
    font-size: 14px;
    letter-spacing: 4px;
    color: #555;
    text-transform: uppercase;
  }

  /* --- SELECT PAGE (shared) --- */
  .select-page {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100vh;
    overflow: hidden;
    background: radial-gradient(ellipse at 50% 0%, #1a0033 0%, var(--bg) 60%);
  }
  .select-page-p2 {
    background: radial-gradient(ellipse at 50% 0%, #33000d 0%, var(--bg) 60%);
  }

  /* TOP: big char info display */
  .sp-top {
    display: flex;
    flex-direction: column;
    padding: 24px 28px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    position: relative;
    min-height: 200px;
  }
  .sp-top-accent {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .sp-page-p1 .sp-top-accent { background: var(--p1); box-shadow: 0 0 20px var(--p1); }
  .sp-page-p2 .sp-top-accent { background: var(--p2); box-shadow: 0 0 20px var(--p2); }

  .sp-player-label {
    font-size: 11px;
    letter-spacing: 5px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .sp-page-p1 .sp-player-label { color: var(--p1); }
  .sp-page-p2 .sp-player-label { color: var(--p2); }

  .sp-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    animation: blink 1.2s ease-in-out infinite;
  }
  .sp-page-p1 .sp-dot { background: var(--p1); box-shadow: 0 0 8px var(--p1); }
  .sp-page-p2 .sp-dot { background: var(--p2); box-shadow: 0 0 8px var(--p2); }

  .sp-char-main {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1;
  }

  .sp-char-emoji {
    font-size: 72px;
    line-height: 1;
    flex-shrink: 0;
    transition: all 0.3s ease;
    animation: floatEmoji 3s ease-in-out infinite;
    filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
  }

  .sp-char-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .sp-char-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(36px, 6vw, 64px);
    letter-spacing: 5px;
    line-height: 1;
    transition: color 0.3s;
  }
  .sp-char-tag {
    font-size: 11px;
    letter-spacing: 3px;
    color: #555;
    text-transform: uppercase;
  }
  .sp-char-desc {
    font-size: 14px;
    color: #888;
    line-height: 1.7;
    max-width: 500px;
    transition: all 0.2s;
  }
  .sp-char-placeholder {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 5px;
    color: #222;
  }

  /* MP Role badge */
  .mp-role-badge {
    display: inline-block;
    font-size: 11px;
    letter-spacing: 3px;
    padding: 3px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    margin-top: 8px;
    align-self: flex-start;
  }
  .mp-role-badge.host { background: rgba(0,229,255,0.1); border: 1px solid rgba(0,229,255,0.4); color: var(--p1); }
  .mp-role-badge.guest { background: rgba(255,68,68,0.1); border: 1px solid rgba(255,68,68,0.4); color: var(--p2); }

  /* MP waiting */
  .mp-waiting-char {
    display: none;
    font-size: 12px;
    letter-spacing: 2px;
    color: #555;
    animation: blink 1.2s ease-in-out infinite;
    margin-top: 6px;
  }
  .mp-waiting-char.show { display: block; }
  .mp-char-hint { font-size: 11px; letter-spacing: 2px; color: #444; text-transform: uppercase; margin-top: 4px; }

  /* Also-picking banner (MP) */
  .sp-opponent-banner {
    display: none;
    position: absolute;
    top: 12px; right: 16px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    text-align: right;
  }
  .sp-opponent-banner.show { display: block; }
  .sp-opp-label { font-size: 9px; letter-spacing: 3px; color: #444; text-transform: uppercase; }
  .sp-opp-char { font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 2px; color: #555; }

  /* BOTTOM: char grid */
  .sp-bottom {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sp-bottom-header {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .sp-bottom-title {
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: #444;
  }
  .sp-confirm-btn {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 4px;
    padding: 8px 28px;
    border: 2px solid;
    border-radius: 6px;
    cursor: pointer;
    background: transparent;
    transition: all 0.2s;
  }
  .sp-page-p1 .sp-confirm-btn { border-color: var(--p1); color: var(--p1); }
  .sp-page-p1 .sp-confirm-btn:not(:disabled):hover { background: var(--p1); color: #000; box-shadow: 0 0 20px rgba(0,229,255,0.4); }
  .sp-page-p2 .sp-confirm-btn { border-color: var(--p2); color: var(--p2); }
  .sp-page-p2 .sp-confirm-btn:not(:disabled):hover { background: var(--p2); color: #fff; box-shadow: 0 0 20px rgba(255,68,68,0.4); }
  .sp-confirm-btn:disabled { border-color: #2a2a2a; color: #333; cursor: not-allowed; }

  /* Char grid */
  .chars {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 8px;
    align-content: start;
    scrollbar-width: thin;
    scrollbar-color: #222 transparent;
  }
  .chars::-webkit-scrollbar { width: 4px; }
  .chars::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  /* Char tile (compact) */
  .char-card {
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 10px 6px 8px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    background: rgba(255,255,255,0.02);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    text-align: center;
    user-select: none;
  }
  .char-card:hover { border-color: #555; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.5); }
  .char-card.selected-nuke   { border-color: var(--nuke-color);  background: rgba(255,107,0,0.12);  box-shadow: 0 0 20px rgba(255,107,0,0.3); }
  .char-card.selected-doge   { border-color: var(--doge-color);  background: rgba(0,255,136,0.1);   box-shadow: 0 0 20px rgba(0,255,136,0.3); }
  .char-card.selected-world  { border-color: var(--world-color); background: rgba(204,68,255,0.1);  box-shadow: 0 0 20px rgba(204,68,255,0.3); }
  .char-card.selected-mih    { border-color: #fff; background: rgba(255,255,255,0.07); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
  .char-card.selected-counter{ border-color: #ffdd00; background: rgba(255,220,0,0.08); box-shadow: 0 0 20px rgba(255,220,0,0.3); }
  .char-card.selected-tank   { border-color: #aaffaa; background: rgba(100,255,100,0.08); box-shadow: 0 0 20px rgba(100,255,100,0.3); }
  .char-card.selected-pohon  { border-color: #00ff44; background: rgba(0,255,68,0.08); box-shadow: 0 0 20px rgba(0,255,68,0.4); }
  .char-card.selected-div2   { border-color: #ff44cc; background: rgba(255,68,204,0.08); box-shadow: 0 0 20px rgba(255,68,204,0.3); }
  .char-card.selected-undeath{ border-color: #aa44ff; background: rgba(170,68,255,0.08); box-shadow: 0 0 20px rgba(170,68,255,0.3); }
  .char-card.selected-jhon   { border-color: #ffe066; background: rgba(255,224,102,0.08); box-shadow: 0 0 20px rgba(255,224,102,0.35); }
  .char-card.selected-writer { border-color: #00ccff; background: rgba(0,204,255,0.08); box-shadow: 0 0 20px rgba(0,204,255,0.3); }

  .char-emoji {
    font-size: 28px;
    line-height: 1;
    animation: floatEmoji 2.5s ease-in-out infinite;
    display: block !important;
  }
  .char-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    letter-spacing: 1px;
    line-height: 1.2;
    display: block !important;
  }
  /* char colors in grid */
  .char-card[data-char="nuke"]   .char-name { color: var(--nuke-color); }
  .char-card[data-char="doge"]   .char-name { color: var(--doge-color); }
  .char-card[data-char="world"]  .char-name { color: var(--world-color); }
  .char-card[data-char="mih"]    .char-name { color: #fff; }
  .char-card[data-char="counter"].char-name { color: #ffdd00; }
  .char-card[data-char="tank"]   .char-name { color: #aaffaa; }
  .char-card[data-char="div2"]   .char-name { color: #ff44cc; }
  .char-card[data-char="undeath"].char-name { color: #aa44ff; }
  .char-card[data-char="pohon"]  .char-name { color: #00ff44; }
  .char-card[data-char="jhon"]   .char-name { color: #ffe066; }
  .char-card[data-char="writer"] .char-name { color: #00ccff; }

  /* check badge */
  .check {
    position: absolute;
    top: 5px; right: 5px;
    width: 16px; height: 16px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; font-weight: bold;
    opacity: 0; transition: opacity 0.2s;
  }
  .selected-nuke  .check { background: var(--nuke-color); opacity:1; }
  .selected-doge  .check { background: var(--doge-color); opacity:1; }
  .selected-world .check { background: var(--world-color); opacity:1; }
  .selected-mih   .check { background: #fff; opacity:1; color:#000; }
  .selected-counter .check { background: #ffdd00; opacity:1; color:#000; }
  .selected-tank  .check { background: #aaffaa; opacity:1; color:#000; }
  .selected-pohon .check { background: #00ff44; opacity:1; color:#000; }
  .selected-div2  .check { background: #ff44cc; opacity:1; }
  .selected-undeath .check { background: #aa44ff; opacity:1; }
  .selected-jhon  .check { background: #ffe066; opacity:1; color:#000; }
  .selected-writer .check { background: #00ccff; opacity:1; color:#000; }

  /* Tile card: show emoji and name, hide description details */
  .char-top { display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 4px; margin: 0; }
  .char-info { display: flex; flex-direction: column; align-items: center; }
  .char-tag { display: none; }
  .char-desc { display: none; }

  /* select-hint in bottom bar */
  .select-hint {
    font-size: 11px;
    letter-spacing: 2px;
    color: #444;
    text-transform: uppercase;
  }

  /* hide old layout artifacts */
  .select-arena { display: none !important; }
  .vs-divider { display: none !important; }
  #panel-p1, #panel-p2 { display: none !important; }
  .start-btn { display: none !important; }
  .select-screen { display: none !important; }

  /* SECRET BOX */
  .secret-box {
    position: fixed;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 100;
    opacity: 0.15;
    transition: opacity 0.3s;
  }
  .secret-box:hover { opacity: 1; }
  .secret-label { font-size: 9px; letter-spacing: 2px; color: #333; margin-bottom: 4px; text-transform: uppercase; }
  .secret-inputs { display: flex; gap: 4px; }
  .secret-digit {
    width: 28px; height: 28px;
    background: #111; border: 1px solid #222;
    border-radius: 4px; color: #555;
    text-align: center; font-family: 'Bebas Neue', sans-serif;
    font-size: 16px; outline: none;
  }
  .secret-digit:focus { border-color: #444; color: #888; }

  /* ===== WRITER CHOICE OVERLAY ===== */
  .writer-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 500;
    align-items: center;
    justify-content: center;
  }
  .writer-overlay.show { display: flex; }
  .writer-box {
    background: #0a0a0a;
    border: 1px solid #00ccff;
    border-radius: 12px;
    padding: 28px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 0 40px rgba(0,204,255,0.2);
  }
  .writer-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 4px;
    color: #00ccff;
    margin-bottom: 4px;
  }
  .writer-sub {
    font-size: 11px;
    letter-spacing: 3px;
    color: #555;
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  .writer-choices { display: flex; flex-direction: column; gap: 8px; }
  .writer-choice-btn {
    background: transparent;
    border: 1px solid #1a1a2e;
    border-radius: 8px;
    padding: 12px 16px;
    color: #ccc;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 15px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  .writer-choice-btn:hover { background: #00ccff; color: #000; box-shadow: 0 0 20px rgba(0,204,255,0.4); }
  .writer-choice-btn .choice-desc {
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    letter-spacing: 1px;
    display: block;
    opacity: 0.7;
    margin-top: 2px;
    font-weight: 400;
  }

  /* ===== WIN OVERLAY ===== */
  .win-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 500;
    align-items: center;
    justify-content: center;
  }
  .win-overlay.show { display: flex; }
  .win-box {
    text-align: center;
    padding: 40px;
    border: 1px solid #333;
    border-radius: 16px;
    background: #0a0a0a;
    max-width: 340px;
    width: 90%;
  }
  .win-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 4px;
    color: #ffd700;
    margin-bottom: 12px;
  }
  .win-char { font-size: 64px; margin-bottom: 8px; }
  .win-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 40px;
    letter-spacing: 5px;
    margin-bottom: 4px;
  }
  .win-msg {
    font-size: 14px;
    letter-spacing: 2px;
    color: #666;
    margin-bottom: 24px;
  }
  .replay-btn {
    padding: 12px 32px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 4px;
    background: transparent;
    border: 2px solid #fff;
    color: #fff;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
  }
  .replay-btn:hover { background: #fff; color: #000; }

  /* ===== BATTLE PAGE ===== */
  #page-battle {
    flex-direction: column;
    padding: 8px 12px;
    background: radial-gradient(ellipse at 50% 50%, #0d0d20 0%, var(--bg) 70%);
    gap: 0;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
  }

  .hud {
    display: flex;
    width: 100%;
    max-width: 800px;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .hud-player {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .hud-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #hud-p1 .hud-name { color: var(--p1); }
  #hud-p2 .hud-name { color: var(--p2); justify-content: flex-end; }

  .hp-bar-wrap {
    height: 8px;
    background: #111;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #222;
  }

  .hp-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease, background 0.3s;
  }

  #hud-p1 .hp-bar { background: linear-gradient(90deg, var(--p1), #0088aa); }
  #hud-p2 .hp-bar { background: linear-gradient(270deg, var(--p2), #aa0000); }

  .hp-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    color: #888;
  }

  .skill-cd-label {
    font-size: 11px;
    letter-spacing: 1px;
    color: #555;
  }

  .hud-vs {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: #333;
    flex-shrink: 0;
  }

  /* Arena */
  .arena-wrap {
    width: 100%;
    max-width: 800px;
    flex-shrink: 0;
    display: block;
  }

  #arena {
    width: 100%;
    height: 280px;
    min-height: 280px;
    max-height: 280px;
    background: #050510;
    border: 1px solid #222244;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    display: block;
  }

  .ground {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 50px;
    background: linear-gradient(180deg, #0a0a1a 0%, #0d0d20 100%);
    border-top: 1px solid #1a1a3e;
    overflow: hidden;
  }

  .ground-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(0deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 30px 30px;
  }

  /* Ball */
  .ball {
    position: absolute;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 34px;
    line-height: 1;
    transition: filter 0.1s;
    z-index: 10;
    cursor: default;
    user-select: none;
    background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.25), rgba(255,255,255,0.05) 60%, rgba(0,0,0,0.4));
    box-shadow: 0 4px 15px rgba(0,0,0,0.6), inset 0 1px 3px rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.1);
  }
  #ball-p1 {
    background: radial-gradient(circle at 35% 35%, rgba(0,200,255,0.35), rgba(0,100,150,0.2) 60%, rgba(0,0,0,0.5));
    box-shadow: 0 0 18px rgba(0,200,255,0.5), 0 4px 12px rgba(0,0,0,0.6);
    border: 1px solid rgba(0,200,255,0.4);
  }
  #ball-p2 {
    background: radial-gradient(circle at 35% 35%, rgba(255,80,80,0.35), rgba(150,30,30,0.2) 60%, rgba(0,0,0,0.5));
    box-shadow: 0 0 18px rgba(255,80,80,0.5), 0 4px 12px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,80,80,0.4);
  }

  .ball.hit { animation: hitFlash 0.15s ease; }
  @keyframes hitFlash {
    0% { filter: brightness(3) saturate(0); }
    100% { filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6)); }
  }

  .ball.stunned { filter: brightness(0.5) saturate(0); animation: stunPulse 0.3s ease-in-out infinite; }
  @keyframes stunPulse { 0%,100%{filter:brightness(0.4) saturate(0)} 50%{filter:brightness(0.7) saturate(0.3)} }

  .ball.mih-active { filter: drop-shadow(0 0 12px #fff) brightness(1.4); }
  .ball.counter-clash { animation: counterFlash 0.1s ease 3; }
  @keyframes counterFlash { 0%{filter:brightness(4)} 100%{filter:none} }

  /* Nuke timer HUD */
  .nuke-timer {
    position: absolute;
    top: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    color: #ff6b00;
    text-shadow: 0 0 10px rgba(255,107,0,0.5);
    z-index: 20;
    pointer-events: none;
  }

  /* World freeze overlay */
  .world-freeze {
    position: absolute;
    inset: 0;
    background: rgba(100,0,200,0.15);
    border: 2px solid rgba(180,0,255,0.4);
    border-radius: 10px;
    pointer-events: none;
    z-index: 15;
    animation: freezePulse 0.5s ease-in-out infinite;
  }
  @keyframes freezePulse { 0%,100%{opacity:0.6} 50%{opacity:1} }

  .world-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(28px, 8vw, 60px);
    letter-spacing: 8px;
    color: #cc44ff;
    text-shadow: 0 0 30px rgba(180,0,255,0.8);
    pointer-events: none;
    z-index: 16;
    animation: worldTextAnim 0.3s ease;
  }
  @keyframes worldTextAnim { 0%{transform:translate(-50%,-50%) scale(2);opacity:0} 100%{transform:translate(-50%,-50%) scale(1);opacity:1} }

  /* Counter text */
  .counter-text {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 6px;
    color: #ffdd00;
    text-shadow: 0 0 20px rgba(255,220,0,0.8);
    pointer-events: none;
    z-index: 20;
    animation: counterAnim 0.8s ease forwards;
  }
  @keyframes counterAnim { 0%{transform:translate(-50%,-50%) scale(1.5);opacity:1} 100%{transform:translate(-50%,-100%) scale(0.8);opacity:0} }

  /* Explosion */
  .explosion {
    position: absolute;
    width: 0; height: 0;
    border-radius: 50%;
    background: radial-gradient(circle, #fff 0%, #ffaa00 30%, #ff4400 60%, transparent 80%);
    transform: translate(-50%, -50%);
    animation: explodeAnim 0.7s ease-out forwards;
    pointer-events: none;
    z-index: 20;
  }
  @keyframes explodeAnim {
    0%   { width: 0; height: 0; opacity: 1; }
    50%  { width: 120px; height: 120px; opacity: 0.9; }
    100% { width: 200px; height: 200px; opacity: 0; }
  }

  /* Stun stars */
  .stun-stars {
    position: absolute;
    font-size: 18px;
    pointer-events: none;
    z-index: 21;
    animation: starSpin 0.6s linear infinite;
  }
  @keyframes starSpin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

  /* Miss text */
  .miss-text {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 3px;
    color: #00ff88;
    text-shadow: 0 0 10px rgba(0,255,136,0.6);
    pointer-events: none;
    z-index: 20;
    animation: missAnim 0.8s ease-out forwards;
  }
  @keyframes missAnim {
    0%   { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-50px); opacity: 0; }
  }

  /* Damage number */
  .dmg-number {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    font-weight: bold;
    pointer-events: none;
    z-index: 20;
    animation: dmgAnim 1s ease-out forwards;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }
  @keyframes dmgAnim {
    0%   { transform: translateY(0) scale(1); opacity: 1; }
    30%  { transform: translateY(-20px) scale(1.2); opacity: 1; }
    100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
  }

  /* Jhon slow ring */
  .jhon-slow-ring {
    position: absolute;
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 2px solid rgba(255,224,102,0.6);
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 12;
    animation: slowRingPulse 0.8s ease-in-out infinite;
  }
  @keyframes slowRingPulse { 0%,100%{opacity:0.4;transform:translate(-50%,-50%) scale(1)} 50%{opacity:0.8;transform:translate(-50%,-50%) scale(1.1)} }

  /* Pohon tree */
  .pohon-tree {
    position: absolute;
    font-size: 32px;
    z-index: 11;
    pointer-events: none;
    animation: treeAppear 0.2s ease;
    transform: translate(-50%, -100%);
  }
  @keyframes treeAppear { 0%{transform:translate(-50%,-100%) scale(0)} 100%{transform:translate(-50%,-100%) scale(1)} }

  /* Skill bars */
  .skill-bars {
    display: flex;
    width: 100%;
    max-width: 800px;
    gap: 10px;
    margin-top: 8px;
  }

  .skill-bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .skill-bar-group.right { text-align: right; }

  .skill-bar-label {
    font-size: 10px;
    letter-spacing: 1px;
    color: #444;
    text-transform: uppercase;
  }

  .cooldown-bar {
    height: 4px;
    background: #111;
    border-radius: 2px;
    overflow: hidden;
    border: 1px solid #1a1a2e;
  }

  .cooldown-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--p1), #00aaff);
    border-radius: 2px;
    transition: width 1s linear;
  }

  .skill-bar-group.right .cooldown-fill {
    background: linear-gradient(270deg, var(--p2), #aa0000);
    margin-left: auto;
  }

  /* Speed/Judge button */
  #speed-btn-wrap { text-align: center; margin-top: 8px; width: 100%; }
  #speed-btn {
    padding: 10px 28px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    background: linear-gradient(135deg, #ffd700, #ff8800);
    border: none;
    color: #000;
    cursor: pointer;
    border-radius: 6px;
    animation: btnPulse 1s ease-in-out infinite;
  }
  @keyframes btnPulse { 0%,100%{box-shadow:0 0 10px rgba(255,215,0,0.4)} 50%{box-shadow:0 0 25px rgba(255,215,0,0.8)} }

  /* Battle log */
  .battle-log {
    width: 100%;
    max-width: 800px;
    max-height: 140px;
    overflow-y: auto;
    margin-top: 8px;
    scrollbar-width: thin;
    scrollbar-color: #222 transparent;
  }
  .battle-log::-webkit-scrollbar { width: 3px; }
  .battle-log::-webkit-scrollbar-thumb { background: #333; }

  .log-inner {
    display: flex;
    flex-direction: column-reverse;
    gap: 2px;
  }

  .log-entry {
    font-size: 12px;
    letter-spacing: 1px;
    padding: 2px 6px;
    border-radius: 3px;
    opacity: 0.85;
  }
  .log-entry.p1 { color: var(--p1); }
  .log-entry.p2 { color: var(--p2); }
  .log-entry.special { color: #ffd700; }
  .log-entry.heal { color: #00ff88; }

  /* Collision flash */
  .collision-flash {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,200,0,0.6) 40%, transparent 70%);
    animation: collisionFlashAnim 0.4s ease-out forwards;
    pointer-events: none;
    z-index: 22;
  }
  @keyframes collisionFlashAnim {
    0%  { width: 0; height: 0; opacity: 1; transform: translate(-50%,-50%); }
    100%{ width: 80px; height: 80px; opacity: 0; transform: translate(-50%,-50%); }
  }

</style>
</head>
<body>

<!-- ============ PAGE 0: MAIN MENU ============ -->
<div class="page active" id="page-menu">
  <div class="game-title">BALL BATTLE</div>
  <div class="subtitle">Bola Mantul ¬∑ Skill Otomatis ¬∑ 1v1</div>
  <div class="menu-btns">
    <button class="menu-btn menu-btn-sp" onclick="startSingleplayer()">üéÆ SINGLEPLAYER</button>
    <div class="menu-desc">2 pemain ¬∑ 1 layar ¬∑ Lokal</div>
    <button class="menu-btn menu-btn-mp" onclick="showPage('mp')">üåê MULTIPLAYER</button>
    <div class="menu-desc">Online ¬∑ Room code ¬∑ Beda perangkat</div>
  </div>
</div>

<!-- ============ PAGE: MULTIPLAYER LOBBY ============ -->
<div class="page" id="page-mp">
  <div class="game-title" style="font-size:clamp(32px,5vw,64px)">MULTIPLAYER</div>
  <div class="subtitle">Buka file ini di 2 tab browser ¬∑ Buat room & join dengan kode</div>
  <div class="mp-container">
    <!-- CREATE ROOM -->
    <div class="mp-card mp-card-create">
      <div class="mp-card-title">BUAT ROOM</div>
      <div class="mp-card-emoji">üè†</div>
      <div class="mp-card-desc">Buat room baru dan bagikan kode ke temanmu di <strong style="color:var(--p1)">tab lain</strong>. Kamu jadi <strong style="color:var(--p1)">Player 1</strong>!</div>
      <button class="mp-action-btn" onclick="createRoom()" id="create-room-btn">BUAT ROOM</button>
      <div class="room-code-box" id="room-code-box">
        <div class="room-code-label">üîë Kode Room</div>
        <div class="room-code-value" id="room-code-display">------</div>
        <div class="room-code-status wait-dots">Menunggu Player 2</div>
      </div>
    </div>
    <!-- JOIN ROOM -->
    <div class="mp-card mp-card-join">
      <div class="mp-card-title">JOIN ROOM</div>
      <div class="mp-card-emoji">üöÄ</div>
      <div class="mp-card-desc">Buka file di <strong style="color:var(--p2)">tab lain</strong>, masukkan kode room dari temanmu. Kamu jadi <strong style="color:var(--p2)">Player 2</strong>!</div>
      <div class="join-input-wrap">
        <input class="join-code-input" id="join-code-input" maxlength="6" placeholder="XXXXXX" autocomplete="off" spellcheck="false" oninput="this.value=this.value.toUpperCase()">
        <div class="join-error-msg" id="join-error"></div>
      </div>
      <button class="mp-action-btn" onclick="joinRoom()" id="join-room-btn">GABUNG</button>
    </div>
  </div>
  <button class="back-btn" onclick="backToMenu()" style="margin-top:20px">‚Üê KEMBALI</button>
</div>

<!-- ============ PAGE: WAITING ROOM ============ -->
<div class="page" id="page-mp-wait">
  <div class="wait-title" id="wait-title">MENUNGGU LAWAN</div>
  <div class="wait-label">Kode Room</div>
  <div class="wait-code" id="wait-code-display">------</div>
  <div class="wait-player-status">
    <div class="wait-player-slot ready" id="wait-slot-p1">
      <div class="wait-slot-label">Player 1</div>
      <div class="wait-slot-status" id="wait-status-p1">‚ö° SIAP</div>
    </div>
    <div class="wait-player-slot" id="wait-slot-p2">
      <div class="wait-slot-label">Player 2</div>
      <div class="wait-slot-status" id="wait-status-p2">Menunggu</div>
    </div>
  </div>
  <div class="wait-status" id="wait-status-msg">Menunggu Player 2 masuk room<span class="wait-dots"></span></div>
  <button class="back-btn" onclick="cancelRoom()" style="margin-top:20px" id="cancel-room-btn">BATALKAN</button>
</div>

<!-- ============ PAGE 1A: SELECT P1 ============ -->
<div class="page" id="page-select-p1">
<div class="select-page sp-page-p1">
  <!-- TOP INFO -->
  <div class="sp-top">
    <div class="sp-top-accent"></div>
    <div class="sp-player-label"><div class="sp-dot"></div>PLAYER 1</div>
    <div class="sp-char-main">
      <div class="sp-char-emoji" id="sp-emoji-p1">‚ùì</div>
      <div class="sp-char-info">
        <div class="sp-char-name" id="sp-name-p1" style="color:#222">PILIH KARAKTER</div>
        <div class="sp-char-tag" id="sp-tag-p1"></div>
        <div class="sp-char-desc" id="sp-desc-p1"><span class="sp-char-placeholder">Sentuh karakter di bawah</span></div>
        <div id="mp-role-badge-wrap" style="display:none">
          <span class="mp-role-badge host" id="mp-role-badge">üè† HOST ‚Äî PLAYER 1</span>
        </div>
        <div class="mp-waiting-char" id="mp-waiting-char">‚è≥ Menunggu lawan memilih<span class="wait-dots"></span></div>
        <div class="mp-char-hint" id="mp-char-hint" style="display:none">Pilih lalu tekan KONFIRMASI</div>
        <button class="mp-char-confirm-btn" id="mp-char-confirm-btn" style="display:none" disabled onclick="mpConfirmChar()">KONFIRMASI</button>
      </div>
    </div>
    <!-- MP: opponent status banner -->
    <div class="sp-opponent-banner" id="opp-banner-p1">
      <div class="sp-opp-label">Lawan (P2)</div>
      <div class="sp-opp-char" id="opp-char-p1">Memilih...</div>
    </div>
  </div>

  <!-- BOTTOM GRID -->
  <div class="sp-bottom">
    <div class="sp-bottom-header">
      <div class="sp-bottom-title">Pilih karakter ¬∑ <span id="select-hint" style="color:#555;font-size:10px;letter-spacing:2px">Belum ada yang dipilih</span></div>
      <button class="sp-confirm-btn" id="sp-confirm-p1" disabled onclick="spConfirm(1)">KONFIRMASI</button>
    </div>
    <div class="chars" id="chars-p1">
        <div class="char-card" data-char="nuke" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üí£</div>
            <div class="char-info">
              <div class="char-name">NUKE</div>
              <div class="char-tag">Explosive ¬∑ High Risk</div>
            </div>
          </div>
          <div class="char-desc">Setelah <strong>15 detik</strong>, meledak otomatis: kasih damage ke lawan tapi <strong>dia sendiri juga mati!</strong></div>
        </div>
        <div class="char-card" data-char="doge" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üêï</div>
            <div class="char-info">
              <div class="char-name">DOGE</div>
              <div class="char-tag">Agile ¬∑ Evasive</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, otomatis aktif dodge ‚Äî hindari 1 tumbukan berikutnya!</div>
        </div>
        <div class="char-card" data-char="world" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üåç</div>
            <div class="char-info">
              <div class="char-name">THE WORLD</div>
              <div class="char-tag">Time Stop ¬∑ Stun</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>14 detik</strong>, otomatis <strong>ZA WARUDO!</strong> ‚Äî stun lawan selama 3 detik. Bola lawan berhenti total!</div>
        </div>
        <div class="char-card" data-char="mih" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ö°</div>
            <div class="char-info">
              <div class="char-name">MADE IN HEAVEN</div>
              <div class="char-tag">Speed Up ¬∑ Damage Reduce</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>12 detik</strong>, kecepatan otomatis nambah terus! Punya <strong>15% damage reduce</strong> tapi setiap tumbukan ngurangin <strong>12 HP lawan</strong>.</div>
        </div>
        <div class="char-card" data-char="counter" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üõ°Ô∏è</div>
            <div class="char-info">
              <div class="char-name">COUNTER</div>
              <div class="char-tag">Reactive ¬∑ Skill Cancel</div>
            </div>
          </div>
          <div class="char-desc">Pas lawan pakai skill, <strong>otomatis counter!</strong> Kedua bola saling tabrak ‚Äî skill lawan langsung dibatalin. No cooldown!</div>
        </div>
        <div class="char-card" data-char="tank" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">ü™®</div>
            <div class="char-info">
              <div class="char-name">TANK</div>
              <div class="char-tag">Tanky ¬∑ 1000 HP ¬∑ Armored</div>
            </div>
          </div>
          <div class="char-desc">Punya <strong>1000 HP</strong> tapi hanya terima <strong>1‚Äì2 damage</strong> dari tumbukan. Lambat tapi susah dibunuh!</div>
        </div>
        <div class="char-card" data-char="div2" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ûó</div>
            <div class="char-info">
              <div class="char-name">√∑2</div>
              <div class="char-tag">Passive ¬∑ HP Divider</div>
            </div>
          </div>
          <div class="char-desc"><strong>[PASIF]</strong> Saat HP lawan bisa dibagi 2, damage = <strong>HP lawan √∑ 2</strong>! (cth: 100√∑2=50). Kalau HP ganjil, damage kembali normal.</div>
        </div>
        <div class="char-card" data-char="undeath" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üíÄ</div>
            <div class="char-info">
              <div class="char-name">UNDEATH</div>
              <div class="char-tag">Revive ¬∑ Second Life</div>
            </div>
          </div>
          <div class="char-desc">Saat mati, bangkit sekali! <strong>60%</strong>: isi 10% HP ¬∑ <strong>30%</strong>: isi 20% HP ¬∑ <strong>10%</strong>: isi 100% HP. Satu kali seumur hidup!</div>
        </div>
        <div class="char-card secret-char" data-char="writer" data-player="1" id="writer-card-p1" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128393;</div>
            <div class="char-info">
              <div class="char-name">THE WRITER</div>
              <div class="char-tag">Secret &#183; Choice &#183; Versatile</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>17 detik</strong>, pilih satu: <strong>-50 HP lawan</strong> / <strong>+20 HP diri sendiri</strong> / <strong>Uncounter</strong> (serangan tak bisa di-counter) / <strong>Damage Reduce 20%</strong>.</div>
        </div>
        <div class="char-card secret-char" data-char="jhon" data-player="1" id="jhon-card-p1" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128161;</div>
            <div class="char-info">
              <div class="char-name">JHON</div>
              <div class="char-tag">Secret &#183; Blind &#183; Slow</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, tembak <strong>cahaya terang</strong> ke lawan &#8212; stun <strong>2 detik</strong> lalu slow <strong>5%</strong> selama <strong>4 detik</strong>!</div>
        </div>
        <div class="char-card secret-char" data-char="pohon" data-player="1" id="pohon-card-p1" style="display:none">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji" style="animation:none">üå¥</div>
            <div class="char-info">
              <div class="char-name">POHON</div>
              <div class="char-tag">Secret ¬∑ Hazard ¬∑ Stun Immune</div>
            </div>
          </div>
          <div class="char-desc">Lempar <strong>üå¥ pohon</strong> tiap 5 detik ‚Äî pohon bertahan <strong>3 detik</strong> dan kasih <strong>5 damage</strong> ke siapapun yang kena. <strong>Immune stun ZA WARUDO!</strong></div>
        </div></div>
  </div>

  <div class="secret-box">
    <div class="secret-label">üîí Masukkan Kode Rahasia (5 digit)</div>
    <div class="secret-inputs" id="secret-inputs">
      <input class="secret-digit" maxlength="1" id="sd0" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd1" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd2" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd3" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd4" autocomplete="off" spellcheck="false">
    </div>
  </div>
</div>
</div>

<!-- ============ PAGE 1B: SELECT P2 ============ -->
<div class="page" id="page-select-p2">
<div class="select-page sp-page-p2">
  <!-- TOP INFO -->
  <div class="sp-top">
    <div class="sp-top-accent"></div>
    <div class="sp-player-label"><div class="sp-dot"></div>PLAYER 2</div>
    <div class="sp-char-main">
      <div class="sp-char-emoji" id="sp-emoji-p2">‚ùì</div>
      <div class="sp-char-info">
        <div class="sp-char-name" id="sp-name-p2" style="color:#222">PILIH KARAKTER</div>
        <div class="sp-char-tag" id="sp-tag-p2"></div>
        <div class="sp-char-desc" id="sp-desc-p2"><span class="sp-char-placeholder">Sentuh karakter di bawah</span></div>
        <div class="mp-waiting-char" id="mp-waiting-char-p2">‚è≥ Menunggu lawan memilih<span class="wait-dots"></span></div>
      </div>
    </div>
    <!-- MP: opponent status banner -->
    <div class="sp-opponent-banner" id="opp-banner-p2">
      <div class="sp-opp-label">Lawan (P1)</div>
      <div class="sp-opp-char" id="opp-char-p2">Memilih...</div>
    </div>
  </div>

  <!-- BOTTOM GRID -->
  <div class="sp-bottom">
    <div class="sp-bottom-header">
      <div class="sp-bottom-title">Pilih karakter ¬∑ <span id="select-hint-p2" style="color:#555;font-size:10px;letter-spacing:2px">Belum ada yang dipilih</span></div>
      <button class="sp-confirm-btn" id="sp-confirm-p2" disabled onclick="spConfirm(2)">KONFIRMASI</button>
    </div>
    <div class="chars" id="chars-p2">
        <div class="char-card" data-char="nuke" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üí£</div>
            <div class="char-info">
              <div class="char-name">NUKE</div>
              <div class="char-tag">Explosive ¬∑ High Risk</div>
            </div>
          </div>
          <div class="char-desc">Setelah <strong>15 detik</strong>, meledak otomatis: kasih damage ke lawan tapi <strong>dia sendiri juga mati!</strong></div>
        </div>
        <div class="char-card" data-char="doge" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üêï</div>
            <div class="char-info">
              <div class="char-name">DOGE</div>
              <div class="char-tag">Agile ¬∑ Evasive</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, otomatis aktif dodge ‚Äî hindari 1 tumbukan berikutnya!</div>
        </div>
        <div class="char-card" data-char="world" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üåç</div>
            <div class="char-info">
              <div class="char-name">THE WORLD</div>
              <div class="char-tag">Time Stop ¬∑ Stun</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>14 detik</strong>, otomatis <strong>ZA WARUDO!</strong> ‚Äî stun lawan selama 3 detik. Bola lawan berhenti total!</div>
        </div>
        <div class="char-card" data-char="mih" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ö°</div>
            <div class="char-info">
              <div class="char-name">MADE IN HEAVEN</div>
              <div class="char-tag">Speed Up ¬∑ Damage Reduce</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>12 detik</strong>, kecepatan otomatis nambah terus! Punya <strong>15% damage reduce</strong> tapi setiap tumbukan ngurangin <strong>12 HP lawan</strong>.</div>
        </div>
        <div class="char-card" data-char="counter" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üõ°Ô∏è</div>
            <div class="char-info">
              <div class="char-name">COUNTER</div>
              <div class="char-tag">Reactive ¬∑ Skill Cancel</div>
            </div>
          </div>
          <div class="char-desc">Pas lawan pakai skill, <strong>otomatis counter!</strong> Kedua bola saling tabrak ‚Äî skill lawan langsung dibatalin. No cooldown!</div>
        </div>
        <div class="char-card" data-char="tank" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">ü™®</div>
            <div class="char-info">
              <div class="char-name">TANK</div>
              <div class="char-tag">Tanky ¬∑ 1000 HP ¬∑ Armored</div>
            </div>
          </div>
          <div class="char-desc">Punya <strong>1000 HP</strong> tapi hanya terima <strong>1‚Äì2 damage</strong> dari tumbukan. Lambat tapi susah dibunuh!</div>
        </div>
        <div class="char-card" data-char="div2" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ûó</div>
            <div class="char-info">
              <div class="char-name">√∑2</div>
              <div class="char-tag">Passive ¬∑ HP Divider</div>
            </div>
          </div>
          <div class="char-desc"><strong>[PASIF]</strong> Saat HP lawan bisa dibagi 2, damage = <strong>HP lawan √∑ 2</strong>! (cth: 100√∑2=50). Kalau HP ganjil, damage kembali normal.</div>
        </div>
        <div class="char-card" data-char="undeath" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üíÄ</div>
            <div class="char-info">
              <div class="char-name">UNDEATH</div>
              <div class="char-tag">Revive ¬∑ Second Life</div>
            </div>
          </div>
          <div class="char-desc">Saat mati, bangkit sekali! <strong>60%</strong>: isi 10% HP ¬∑ <strong>30%</strong>: isi 20% HP ¬∑ <strong>10%</strong>: isi 100% HP. Satu kali seumur hidup!</div>
        </div>
        <div class="char-card secret-char" data-char="writer" data-player="2" id="writer-card-p2" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128393;</div>
            <div class="char-info">
              <div class="char-name">THE WRITER</div>
              <div class="char-tag">Secret &#183; Choice &#183; Versatile</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>17 detik</strong>, pilih satu: <strong>-50 HP lawan</strong> / <strong>+20 HP diri sendiri</strong> / <strong>Uncounter</strong> (serangan tak bisa di-counter) / <strong>Damage Reduce 20%</strong>.</div>
        </div>
        <div class="char-card secret-char" data-char="jhon" data-player="2" id="jhon-card-p2" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128161;</div>
            <div class="char-info">
              <div class="char-name">JHON</div>
              <div class="char-tag">Secret &#183; Blind &#183; Slow</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, tembak <strong>cahaya terang</strong> ke lawan &#8212; stun <strong>2 detik</strong> lalu slow <strong>5%</strong> selama <strong>4 detik</strong>!</div>
        </div>
        <div class="char-card secret-char" data-char="pohon" data-player="2" id="pohon-card-p2" style="display:none">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji" style="animation:none">üå¥</div>
            <div class="char-info">
              <div class="char-name">POHON</div>
              <div class="char-tag">Secret ¬∑ Hazard ¬∑ Stun Immune</div>
            </div>
          </div>
          <div class="char-desc">Lempar <strong>üå¥ pohon</strong> tiap 5 detik ‚Äî pohon bertahan <strong>3 detik</strong> dan kasih <strong>5 damage</strong> ke siapapun yang kena. <strong>Immune stun ZA WARUDO!</strong></div>
        </div>
      </div></div>
  </div>
</div>
</div>


<!-- ============ PAGE 2: BATTLE ============ -->
<div class="page" id="page-battle">
  <div class="hud">
    <div class="hud-player" id="hud-p1">
      <div class="hud-name">
        <span id="p1-icon">?</span>
        <span id="p1-hud-name">PLAYER 1</span>
      </div>
      <div class="hp-bar-wrap">
        <div class="hp-bar" id="hp-bar-p1" style="width:100%"></div>
      </div>
      <div class="hp-text" id="hp-text-p1">100 HP</div>
      <div class="skill-cd-label" id="skill-label-p1">Skill: ‚Äî</div>
    </div>
    <div class="hud-vs">VS</div>
    <div class="hud-player" id="hud-p2">
      <div class="hud-name" style="justify-content:flex-end">
        <span id="p2-hud-name">PLAYER 2</span>
        <span id="p2-icon">?</span>
      </div>
      <div class="hp-bar-wrap">
        <div class="hp-bar" id="hp-bar-p2" style="width:100%; margin-left:auto; direction:rtl"></div>
      </div>
      <div class="hp-text" id="hp-text-p2" style="text-align:right">100 HP</div>
      <div class="skill-cd-label" id="skill-label-p2" style="text-align:right">Skill: ‚Äî</div>
    </div>
  </div>

  <div class="arena-wrap">
    <div id="arena">
      <div class="ground"><div class="ground-grid"></div></div>
      <div class="ball" id="ball-p1">üí£</div>
      <div class="ball" id="ball-p2">üí£</div>
    </div>
  </div>

  <div class="skill-bars">
    <div class="skill-bar-group">
      <div class="skill-bar-label" id="cd-label-p1">Skill Cooldown P1</div>
      <div class="cooldown-bar"><div class="cooldown-fill" id="cd-p1"></div></div>
    </div>
    <div class="skill-bar-group right">
      <div class="skill-bar-label" id="cd-label-p2">Skill Cooldown P2</div>
      <div class="cooldown-bar"><div class="cooldown-fill" id="cd-p2"></div></div>
    </div>
  </div>

  <div id="speed-btn-wrap" style="display:none;text-align:center">
    <button id="speed-btn" onclick="judgeWinner()">üèÜ LIHAT PEMENANG üèÜ</button>
  </div>

  <div class="battle-log">
    <div class="log-inner" id="log-inner"></div>
  </div>
</div>

<!-- WRITER CHOICE MODAL -->
<div class="writer-overlay" id="writer-overlay">
  <div class="writer-box">
    <div class="writer-title">&#128393; THE WRITER</div>
    <div class="writer-sub" id="writer-modal-sub">PLAYER ? &#8212; PILIH EFEK</div>
    <div class="writer-choices">
      <button class="writer-choice-btn" onclick="writerChoose(1)">
        &#128148; -50 HP LAWAN
        <span class="choice-desc">Kurangi 50 HP langsung dari lawan</span>
      </button>
      <button class="writer-choice-btn" onclick="writerChoose(2)">
        &#128154; +20 HP DIRI SENDIRI
        <span class="choice-desc">Pulihkan 20 HP untuk diri sendiri</span>
      </button>
      <button class="writer-choice-btn" onclick="writerChoose(3)">
        &#128737; UNCOUNTER
        <span class="choice-desc">Tumbukan berikutnya tidak bisa di-counter</span>
      </button>
      <button class="writer-choice-btn" onclick="writerChoose(4)">
        &#128737; DAMAGE REDUCE 20%
        <span class="choice-desc">Kurangi semua damage masuk sebesar 20% selama 10 detik</span>
      </button>
    </div>
  </div>
</div>

<!-- WIN MODAL -->
<div class="win-overlay" id="win-overlay">
  <div class="win-box" id="win-box">
    <div class="win-label">üèÜ PEMENANG üèÜ</div>
    <div class="win-char" id="win-char">üí£</div>
    <div class="win-title" id="win-title">PLAYER 1</div>
    <div class="win-msg" id="win-msg">menang telak!</div>
    <button class="replay-btn" onclick="replay()">üîÑ MAIN LAGI</button>
  </div>
</div>

<script>
// =========== GAME STATE ===========
let gameMode = 'singleplayer'; // 'singleplayer' | 'multiplayer'
let mpRole = null;
let mpRoomCode = null;
let mpPollInterval = null;

const BALL_SIZE = 60;
const COLLISION_DMG_MIN = 8;
const COLLISION_DMG_MAX = 18;
const COLLISION_COOLDOWN = 600; // ms between collision damage procs
const BALL_SPEED = 5;

const state = {
  chars: { 1: null, 2: null },
  hp: { 1: 100, 2: 100 },
  maxHp: { 1: 100, 2: 100 },
  gameOver: false,

  // Ball physics
  pos: { 1: { x: 80, y: 200 }, 2: { x: 660, y: 200 } },
  vel: { 1: { x: 0, y: 0 },    2: { x: 0, y: 0 } },
  arenaW: 800, arenaH: 380,
  groundY: 50,

  // Skills
  dodge: { 1: false, 2: false },
  stunned: { 1: false, 2: false },
  stunTimeout: { 1: null, 2: null },
  worldRestartTimeout: { 1: null, 2: null },
  dogeRestartTimeout: { 1: null, 2: null },
  mihRestartTimeout: { 1: null, 2: null },
  mihSpeed: { 1: 5, 2: 5 },
  counterClashing: false, // MiH current speed (matches BALL_SPEED=5)

  // Timers
  nukeInterval: { 1: null, 2: null },
  nukeTimer: { 1: 30, 2: 30 },
  dogeSkillInterval: { 1: null, 2: null },
  worldSkillInterval: { 1: null, 2: null },
  worldSkillTimer: { 1: 40, 2: 40 },
  dogeSkillTimer: { 1: 10, 2: 10 },

  skillCdInterval: { 1: null, 2: null },

  lastCollision: 0,
  rafId: null,
  pohonTrees: [],      // active tree hazards [{x,y,el,timeout}]
  pohonSkillInterval: { 1: null, 2: null },
  undeathRevived: { 1: false, 2: false },
  jhonSkillInterval: { 1: null, 2: null },
  battleTimer: null,
  jhonSlowed: { 1: false, 2: false },
  jhonSlowTimeout: { 1: null, 2: null },
  writerSkillInterval: { 1: null, 2: null },
  writerUncounter: { 1: false, 2: false },
  writerDmgReduce: { 1: false, 2: false },
  writerDmgReduceTimeout: { 1: null, 2: null },
  writerPendingPlayer: 0,
};

const charData = {
  nuke:  { icon: 'üí£', name: 'NUKE',      skillName: 'BOMB CHARGE' },
  doge:  { icon: 'üêï', name: 'DOGE',      skillName: 'AUTO DODGE' },
  world: { icon: 'üåç', name: 'THE WORLD', skillName: 'ZA WARUDO' },
  mih:     { icon: '‚ö°', name: 'MADE IN HEAVEN', skillName: 'SPEED UP' },
  counter: { icon: 'üõ°Ô∏è', name: 'COUNTER', skillName: 'COUNTER' },
  tank:    { icon: 'ü™®', name: 'TANK',    skillName: 'ARMOR' },
  pohon:   { icon: 'üå¥', name: 'POHON',   skillName: 'LEMPAR POHON' },
  undeath: { icon: 'üíÄ', name: 'UNDEATH', skillName: 'REVIVE' },
  jhon:    { icon: 'üí°', name: 'JHON',    skillName: 'FLASH BLIND' },
  writer:  { icon: '‚úèÔ∏è', name: 'THE WRITER', skillName: 'WRITE FATE' },
  div2:    { icon: '‚ûó', name: '√∑2',      skillName: 'PASIF: HP HALVER' },
};

const charMeta = {
  nuke:    { color: 'var(--nuke-color)',  tag: 'Explosive ¬∑ High Risk',       desc: 'Setelah <strong>15 detik</strong>, meledak otomatis: kasih damage ke lawan tapi <strong>dia sendiri juga mati!</strong>' },
  doge:    { color: 'var(--doge-color)',  tag: 'Agile ¬∑ Evasive',             desc: 'Setiap <strong>10 detik</strong>, otomatis aktif dodge ‚Äî hindari 1 tumbukan berikutnya!' },
  world:   { color: 'var(--world-color)', tag: 'Time Stop ¬∑ Stun',            desc: 'Setiap <strong>14 detik</strong>, otomatis <strong>ZA WARUDO!</strong> ‚Äî stun lawan selama 3 detik. Bola lawan berhenti total!' },
  mih:     { color: '#ffffff',            tag: 'Speed Up ¬∑ Damage Reduce',    desc: 'Setiap <strong>12 detik</strong>, kecepatan otomatis nambah terus! Punya <strong>15% damage reduce</strong> tapi setiap tumbukan ngurangin <strong>12 HP lawan</strong>.' },
  counter: { color: '#ffdd00',            tag: 'Reactive ¬∑ Skill Cancel',     desc: 'Pas lawan pakai skill, <strong>otomatis counter!</strong> Kedua bola saling tabrak ‚Äî skill lawan langsung dibatalin. No cooldown!' },
  tank:    { color: '#aaffaa',            tag: 'Tanky ¬∑ 1000 HP ¬∑ Armored',   desc: 'Punya <strong>1000 HP</strong> tapi hanya terima <strong>1‚Äì2 damage</strong> dari tumbukan. Lambat tapi susah dibunuh!' },
  div2:    { color: '#ff44cc',            tag: 'Passive ¬∑ HP Divider',        desc: '<strong>[PASIF]</strong> Saat HP lawan bisa dibagi 2, damage = <strong>HP lawan √∑ 2</strong>! (cth: 100√∑2=50). Kalau HP ganjil, damage kembali normal.' },
  undeath: { color: '#aa44ff',            tag: 'Revive ¬∑ Second Life',        desc: 'Saat mati, bangkit sekali! <strong>60%</strong>: isi 10% HP ¬∑ <strong>30%</strong>: isi 20% HP ¬∑ <strong>10%</strong>: isi 100% HP. Satu kali seumur hidup!' },
  pohon:   { color: '#00ff44',            tag: 'Secret ¬∑ Hazard ¬∑ Stun Immune', desc: 'Lempar <strong>üå¥ pohon</strong> tiap 5 detik ‚Äî pohon bertahan <strong>3 detik</strong> dan kasih <strong>5 damage</strong> ke siapapun yang kena. <strong>Immune stun ZA WARUDO!</strong>' },
  jhon:    { color: '#ffe066',            tag: 'Secret ¬∑ Blind ¬∑ Slow',       desc: 'Setiap <strong>10 detik</strong>, tembak <strong>cahaya terang</strong> ke lawan ‚Äî stun <strong>2 detik</strong> lalu slow <strong>5%</strong> selama <strong>4 detik</strong>!' },
  writer:  { color: '#00ccff',            tag: 'Secret ¬∑ Choice ¬∑ Versatile', desc: 'Setiap <strong>17 detik</strong>, pilih satu: <strong>-50 HP lawan</strong> / <strong>+20 HP diri sendiri</strong> / <strong>Uncounter</strong> / <strong>Damage Reduce 20%</strong>.' },
};

function updateSpPreview(player, char) {
  const cd = charData[char];
  const cm = charMeta[char] || {};
  document.getElementById('sp-emoji-p' + player).textContent = cd.icon;
  document.getElementById('sp-name-p' + player).textContent  = cd.name;
  document.getElementById('sp-name-p' + player).style.color  = cm.color || '#fff';
  document.getElementById('sp-tag-p'  + player).textContent  = cm.tag  || '';
  document.getElementById('sp-desc-p' + player).innerHTML    = cm.desc || '';
}

// =========== SELECT LOGIC ===========
const UNSELECT_CLASSES = ['selected-nuke','selected-doge','selected-world','selected-mih','selected-counter','selected-tank','selected-pohon','selected-div2','selected-undeath','selected-jhon','selected-writer'];

document.querySelectorAll('.char-card').forEach(card => {
  card.addEventListener('click', () => {
    const player = parseInt(card.dataset.player);
    const char = card.dataset.char;
    // Deselect others in same panel
    document.querySelectorAll(`#chars-p${player} .char-card`).forEach(c => c.classList.remove(...UNSELECT_CLASSES));
    card.classList.add('selected-' + char);
    state.chars[player] = char;
    updateSpPreview(player, char);
    checkReady();
  });
  card.addEventListener('mouseenter', () => {
    const player = parseInt(card.dataset.player);
    const char = card.dataset.char;
    if (!state.chars[player]) updateSpPreview(player, char);
  });
});

// spConfirm: called by the KONFIRMASI button on each page
function spConfirm(player) {
  if (!state.chars[player]) return;
  if (gameMode === 'multiplayer') {
    mpConfirmChar();
    return;
  }
  // Singleplayer
  if (player === 1) {
    // Lock P1, go to P2 page
    document.querySelectorAll('#chars-p1 .char-card').forEach(c => c.style.pointerEvents = 'none');
    document.getElementById('sp-confirm-p1').disabled = true;
    document.getElementById('sp-confirm-p1').textContent = '‚úì OK';
    showPage('select-p2');
  } else {
    // P2 confirmed ‚Äî both ready, start battle
    if (!state.chars[1]) {
      showPage('select-p1');
      return;
    }
    startBattle();
  }
}

function checkReady() {
  const p1 = state.chars[1];
  const p2 = state.chars[2];

  // Update confirm buttons
  const b1 = document.getElementById('sp-confirm-p1');
  const b2 = document.getElementById('sp-confirm-p2');
  if (b1) b1.disabled = !p1;
  if (b2) b2.disabled = !p2;

  if (gameMode === 'multiplayer') {
    const myPlayer = mpRole === 'host' ? 1 : 2;
    const mpBtn = document.getElementById('mp-char-confirm-btn');
    if (mpBtn) mpBtn.disabled = !state.chars[myPlayer];
    return;
  }

  // Update hints
  const hint1 = document.getElementById('select-hint');
  if (hint1) hint1.textContent = p1 ? charData[p1].name + ' dipilih!' : 'Belum ada yang dipilih';
  const hint2 = document.getElementById('select-hint-p2');
  if (hint2) hint2.textContent = p2 ? charData[p2].name + ' dipilih!' : 'Belum ada yang dipilih';
}

// start-btn removed; spConfirm() handles battle start

// =========== ARENA SIZE ===========
function getArenaSize() {
  const arena = document.getElementById('arena');
  return { w: arena.clientWidth, h: arena.clientHeight };
}

// =========== BATTLE INIT ===========
function startBattle() {
  // Show battle page FIRST so arena has real dimensions
  showPage('battle');

  const arena = document.getElementById('arena');
  // Force reflow so clientWidth is real
  arena.getBoundingClientRect();
  const w = arena.clientWidth || 360;
  const h = arena.clientHeight || 300;

  // Set HP based on character
  [1, 2].forEach(p => {
    const opp = p === 1 ? 2 : 1;
    const isTank = state.chars[p] === 'tank';
    const isCounterVsTank = state.chars[p] === 'counter' && state.chars[opp] === 'tank';
    const isPohon = state.chars[p] === 'pohon';
    const hp = isTank ? 1000 : isPohon ? 100 : isCounterVsTank ? 500 : 100;
    state.hp[p] = hp;
    state.maxHp[p] = hp;
  });
  state.dodge = { 1: false, 2: false };
  state.stunned = { 1: false, 2: false };
  state.mihSpeed = { 1: 5, 2: 5 }; // reset to base BALL_SPEED
  state.counterClashing = false;
  state.gameOver = false;
  state.lastCollision = 0;

  // Initial positions (middle height)
  const aW = w > 100 ? w : arena.offsetWidth || 360;
  state.pos[1] = { x: 40,          y: 100 };
  state.pos[2] = { x: Math.max(aW - 40 - BALL_SIZE, 100), y: 100 };

  // Initial velocities ‚Äî diagonal, constant speed
  const angle1 = Math.PI * 0.25 + Math.random() * 0.3;
  const angle2 = Math.PI * 0.75 - Math.random() * 0.3;
  state.vel[1] = { x: Math.cos(angle1) * BALL_SPEED, y: Math.sin(angle1) * BALL_SPEED };
  state.vel[2] = { x: Math.cos(angle2) * BALL_SPEED, y: Math.sin(angle2) * BALL_SPEED };

  document.getElementById('log-inner').innerHTML = '';

  [1, 2].forEach(p => {
    const ch = charData[state.chars[p]];
    document.getElementById(`p${p}-icon`).textContent = ch.icon;
    document.getElementById(`p${p}-hud-name`).textContent = `P${p} ¬∑ ${ch.name}`;
    const ballEl = document.getElementById(`ball-p${p}`);
    ballEl.textContent = ch.icon;
    ballEl.classList.remove('mih-active', 'stunned', 'hit');
    document.getElementById(`cd-p${p}`).style.width = '0%';
    updateHpBar(p);

    // Clear old timers
    clearTimeout(state.nukeInterval[p]);
    clearTimeout(state.dogeSkillInterval[p]);
    clearTimeout(state.worldSkillInterval[p]);
    clearTimeout(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.worldRestartTimeout[p]) clearTimeout(state.worldRestartTimeout[p]);
    if (state.dogeRestartTimeout[p]) clearTimeout(state.dogeRestartTimeout[p]);
    if (state.mihRestartTimeout[p]) clearTimeout(state.mihRestartTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();
    if (state.writerSkillInterval[p]) clearTimeout(state.writerSkillInterval[p]);
    if (state.writerDmgReduceTimeout[p]) clearTimeout(state.writerDmgReduceTimeout[p]);
    state.writerUncounter[p] = false;
    state.writerDmgReduce[p] = false;

    const el = document.getElementById(`nuke-timer-${p}`);
    if (el) el.remove();
    document.getElementById(`ball-p${p}`)?.classList.remove('counter-clash', 'mih-active', 'stunned');
  });

  // Clear any leftover pohon trees
  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];

  // Remove world overlay if any
  const wf = document.getElementById('world-freeze');
  if (wf) wf.remove();
  const wt = document.getElementById('world-text');
  if (wt) wt.remove();

  addLog('üîî BATTLE DIMULAI! Bola mulai mantul!', 'special');
  addLog('üí• Tumbukan antar bola = DAMAGE!', 'special');

  // Start skill timers
  [1, 2].forEach(p => {
    if (state.chars[p] === 'nuke')  startNukeTimer(p);
    if (state.chars[p] === 'doge')  startDogeSkillTimer(p);
    if (state.chars[p] === 'world') startWorldSkillTimer(p);
    if (state.chars[p] === 'mih')   startMihTimer(p);
    if (state.chars[p] === 'counter') {
      document.getElementById(`skill-label-p${p}`).textContent = 'üõ°Ô∏è Counter: SIAP';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'tank') {
      document.getElementById(`skill-label-p${p}`).textContent = 'ü™® ARMOR: AKTIF';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'pohon') startPohonTimer(p);
    if (state.chars[p] === 'undeath') {
      state.undeathRevived[p] = false;
      document.getElementById(`skill-label-p${p}`).textContent = 'üíÄ REVIVE: SIAP';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'writer') {
      state.writerUncounter[p] = false;
      state.writerDmgReduce[p] = false;
      startWriterTimer(p);
    }
    if (state.chars[p] === 'jhon') {
      state.jhonSlowed[p] = false;
      startJhonTimer(p);
    }
    if (state.chars[p] === 'div2') {
      document.getElementById(`skill-label-p${p}`).textContent = '‚ûó PASIF: HP Halver AKTIF';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
  });

  // Start physics loop
  if (state.rafId) cancelAnimationFrame(state.rafId);
  document.getElementById('speed-btn-wrap').style.display = 'none';
  if (state.battleTimer) clearTimeout(state.battleTimer);
  state.battleTimer = setTimeout(() => {
    if (!state.gameOver) {
      document.getElementById('speed-btn-wrap').style.display = 'block';
      document.getElementById('speed-btn').style.display = 'inline-block';
      addLog('üèÜ Permainan > 20 detik! Tekan LIHAT PEMENANG untuk akhiri!', 'special');
    }
  }, 20000);
  // Immediately set initial ball positions in DOM before first frame
  [1, 2].forEach(p => {
    const b = document.getElementById('ball-p' + p);
    if (b) {
      b.style.left = state.pos[p].x + 'px';
      b.style.top  = state.pos[p].y + 'px';
    }
  });

  gameLoop();
}

// =========== PHYSICS LOOP ===========
// No gravity ‚Äî pure billiard bounce, constant speed

function gameLoop(ts = 0) {
  if (state.gameOver) return;

  const arena = document.getElementById('arena');
  const w = arena.clientWidth;
  const h = arena.clientHeight;

  // GUEST: skip physics, posisi sudah diupdate oleh state_sync dari host
  if (gameMode === 'multiplayer' && mpRole === 'guest') {
    state.rafId = requestAnimationFrame(gameLoop);
    return;
  }

  [1, 2].forEach(p => {
    if (state.stunned[p]) return;

    // Move
    state.pos[p].x += state.vel[p].x;
    state.pos[p].y += state.vel[p].y;

    // --- Floor bounce (ground div is 50px tall) ---
    const floor = h - 50;
    if (state.pos[p].y + BALL_SIZE >= floor) {
      state.pos[p].y = floor - BALL_SIZE;
      state.vel[p].y = -Math.abs(state.vel[p].y);
    }

    // --- Ceiling bounce ---
    if (state.pos[p].y <= 0) {
      state.pos[p].y = 0;
      state.vel[p].y = Math.abs(state.vel[p].y);
    }

    // --- Left wall bounce ---
    if (state.pos[p].x <= 0) {
      state.pos[p].x = 0;
      state.vel[p].x = Math.abs(state.vel[p].x);
    }

    // --- Right wall bounce ---
    if (state.pos[p].x + BALL_SIZE >= w) {
      state.pos[p].x = w - BALL_SIZE;
      state.vel[p].x = -Math.abs(state.vel[p].x);
    }

    // Lock to per-player speed (MiH gets faster over time)
    const jhonMult = state.jhonSlowed[p] ? 0.95 : 1.0;
    const baseSpd = (state.chars[p] === 'mih') ? state.mihSpeed[p] : BALL_SPEED;
    const targetSpd = baseSpd * jhonMult;
    const spd = Math.sqrt(state.vel[p].x**2 + state.vel[p].y**2);
    if (spd > 0.01) {
      state.vel[p].x = (state.vel[p].x / spd) * targetSpd;
      state.vel[p].y = (state.vel[p].y / spd) * targetSpd;
    }

    // Update DOM
    const ball = document.getElementById(`ball-p${p}`);
    ball.style.left = state.pos[p].x + 'px';
    ball.style.top  = state.pos[p].y + 'px';

    // Update stun stars position
    const stars = document.getElementById(`stun-stars-${p}`);
    if (stars) {
      stars.style.left = (state.pos[p].x + BALL_SIZE/2 - 15) + 'px';
      stars.style.top  = (state.pos[p].y - 28) + 'px';
    }
    // Update jhon slow ring position
    const slowRingEl = document.getElementById('jhon-slow-ring-' + p);
    if (slowRingEl) {
      slowRingEl.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
      slowRingEl.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
    }
  });

  // Ball-ball collision
  checkBallCollision();

  // Pohon tree hazard check
  checkPohonTrees();

  // HOST: kirim state ke guest setiap ~6 frame (~100ms pada 60fps)
  if (gameMode === 'multiplayer' && mpRole === 'host') {
    state._syncFrameCount = (state._syncFrameCount || 0) + 1;
    if (state._syncFrameCount >= 6) {
      state._syncFrameCount = 0;
      mpSend({
        type: 'state_sync',
        pos1: { x: state.pos[1].x, y: state.pos[1].y },
        vel1: { x: state.vel[1].x, y: state.vel[1].y },
        pos2: { x: state.pos[2].x, y: state.pos[2].y },
        vel2: { x: state.vel[2].x, y: state.vel[2].y },
        hp1: state.hp[1],
        hp2: state.hp[2],
        stunned1: state.stunned[1],
        stunned2: state.stunned[2],
      });
    }
  }

  state.rafId = requestAnimationFrame(gameLoop);
}

function checkBallCollision() {
  const x1 = state.pos[1].x + BALL_SIZE / 2;
  const y1 = state.pos[1].y + BALL_SIZE / 2;
  const x2 = state.pos[2].x + BALL_SIZE / 2;
  const y2 = state.pos[2].y + BALL_SIZE / 2;

  const dist = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
  if (dist < BALL_SIZE) {
    const angle = Math.atan2(y2-y1, x2-x1);
    const overlap = BALL_SIZE - dist;

    // Only push non-stunned balls
    if (!state.stunned[1]) {
      state.pos[1].x -= Math.cos(angle) * overlap/2;
      state.pos[1].y -= Math.sin(angle) * overlap/2;
    }
    if (!state.stunned[2]) {
      state.pos[2].x += Math.cos(angle) * overlap/2;
      state.pos[2].y += Math.sin(angle) * overlap/2;
    }

    // Reflect: if target stunned, attacker fully bounces off (wall-like)
    const nx = (x2-x1)/dist;
    const ny = (y2-y1)/dist;

    if (state.stunned[1] && !state.stunned[2]) {
      // P1 stunned, P2 bounces off
      const dot2 = state.vel[2].x * nx + state.vel[2].y * ny;
      state.vel[2].x -= 2 * dot2 * nx;
      state.vel[2].y -= 2 * dot2 * ny;
      const spd2 = Math.sqrt(state.vel[2].x**2 + state.vel[2].y**2);
      if (spd2 > 0.01) { state.vel[2].x = (state.vel[2].x/spd2)*BALL_SPEED; state.vel[2].y = (state.vel[2].y/spd2)*BALL_SPEED; }
    } else if (state.stunned[2] && !state.stunned[1]) {
      // P2 stunned, P1 bounces off
      const dot1 = state.vel[1].x * (-nx) + state.vel[1].y * (-ny);
      state.vel[1].x -= 2 * dot1 * (-nx);
      state.vel[1].y -= 2 * dot1 * (-ny);
      const spd1 = Math.sqrt(state.vel[1].x**2 + state.vel[1].y**2);
      if (spd1 > 0.01) { state.vel[1].x = (state.vel[1].x/spd1)*BALL_SPEED; state.vel[1].y = (state.vel[1].y/spd1)*BALL_SPEED; }
    } else {
      // Normal elastic collision
      const dvx = state.vel[1].x - state.vel[2].x;
      const dvy = state.vel[1].y - state.vel[2].y;
      const dot = dvx*nx + dvy*ny;
      if (dot > 0) {
        state.vel[1].x -= dot * nx;
        state.vel[1].y -= dot * ny;
        state.vel[2].x += dot * nx;
        state.vel[2].y += dot * ny;
        [1,2].forEach(p => {
          const spd = Math.sqrt(state.vel[p].x**2 + state.vel[p].y**2);
          if (spd > 0.01) { state.vel[p].x = (state.vel[p].x/spd)*BALL_SPEED; state.vel[p].y = (state.vel[p].y/spd)*BALL_SPEED; }
        });
      }
    }



    // Deal collision damage (with cooldown)
    const now = Date.now();
    if (now - state.lastCollision > COLLISION_COOLDOWN) {
      state.lastCollision = now;
      onBallCollision(x1 + (x2-x1)/2, y1 + (y2-y1)/2);
    }
  }
}

function onBallCollision(cx, cy) {
  if (state.gameOver) return;

  // Flash at collision point
  const arena = document.getElementById('arena');
  const arenaRect = arena.getBoundingClientRect();
  const flash = document.createElement('div');
  flash.className = 'collision-flash';
  flash.style.left = cx + 'px';
  flash.style.top  = cy + 'px';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 400);
  mpBroadcastEvent('collision_flash', { cx, cy });

  // Deal damage to both ‚Äî check dodge, stun x3
  [1, 2].forEach(target => {
    if (state.chars[target] === 'doge' && state.dodge[target] && !state.stunned[target]) {
      // Consume dodge
      state.dodge[target] = false;
      clearDodgeVisual(target);
      // Cancel the auto-expire timeout, restart cooldown now
      if (state.dogeRestartTimeout[target]) clearTimeout(state.dogeRestartTimeout[target]);
      startDogeSkillTimer(target);
      showMiss(target);
      mpBroadcastEvent('dodge', { target });
      addLog(`üêï Player ${target} DODGE tumbukan!`, `p${target}`);
      return;
    }
    const attacker = target === 1 ? 2 : 1;
    // MiH always deals 12 flat dmg; Tank deals only 3-5 (slow, defensive)
    let dmg;
    if (state.chars[attacker] === 'mih') {
      dmg = 12;
    } else if (state.chars[attacker] === 'tank') {
      dmg = Math.floor(Math.random() * 3) + 3; // 3-5
    } else {
      dmg = Math.floor(Math.random() * (COLLISION_DMG_MAX - COLLISION_DMG_MIN + 1)) + COLLISION_DMG_MIN;
    }

    // div2 PASSIVE: if target HP divisible by 2, damage = HP/2
    // Counter membatalkan pasif (damage tetap normal)
    if (state.chars[attacker] === 'div2' && state.chars[target] !== 'counter') {
      const oppHp = state.hp[target];
      if (oppHp % 2 === 0 && oppHp > 0) {
        dmg = Math.floor(oppHp / 2);
      }
    }
    // x3 damage if target is stunned
    if (state.stunned[target]) {
      dmg = dmg * 3;
    }
    dealDamage(target, dmg, attacker);
  });
}

// =========== COUNTER SYSTEM ===========
// Returns true if counter activated (skill should be cancelled)
function tryCounter(skillUser) {
  const opponent = skillUser === 1 ? 2 : 1;
  if (state.chars[opponent] !== 'counter') return false;
  // Writer uncounter active ‚Äî skip counter
  if (state.writerUncounter[skillUser]) {
    state.writerUncounter[skillUser] = false;
    addLog('‚úèÔ∏è UNCOUNTER aktif! Counter P' + opponent + ' di-BLOCK!', 'special');
    return false;
  }
  if (state.gameOver) return false;
  if (state.counterClashing) return false;

  state.counterClashing = true;

  addLog('üõ°Ô∏è COUNTER! P' + opponent + ' batalin skill P' + skillUser + '!', 'special');

  // Show COUNTER! text
  const arena = document.getElementById('arena');
  const ct = document.createElement('div');
  ct.className = 'counter-text';
  ct.textContent = 'COUNTER!';
  arena.appendChild(ct);
  setTimeout(() => ct.remove(), 800);

  // Flash counter player ball only
  const cBall = document.getElementById('ball-p' + opponent);
  cBall.classList.add('counter-clash');
  setTimeout(() => cBall.classList.remove('counter-clash'), 400);

  // Deal damage to skill user
  const dmg = Math.floor(Math.random() * 15) + 12;
  setTimeout(() => {
    if (state.gameOver) return;
    addLog('üõ°Ô∏è Counter hit! P' + skillUser + ' kena ' + dmg + ' dmg!', 'special');
    dealDamage(skillUser, dmg);
    document.getElementById('skill-label-p' + opponent).textContent = 'üõ°Ô∏è Counter: SIAP';
    state.counterClashing = false;
  }, 200);

  return true; // skill cancelled
}

// =========== NUKE TIMER ===========
function startNukeTimer(p) {
  if (state.gameOver || state.chars[p] !== 'nuke') return;
  state.nukeTimer[p] = 15;
  showNukeTimerHUD(p);
  tickNuke(p);
}

function tickNuke(p) {
  if (state.gameOver || state.chars[p] !== 'nuke') return;
  if (state.stunned[p]) {
    // paused ‚Äî check again in 200ms
    state.nukeInterval[p] = setTimeout(() => tickNuke(p), 200);
    return;
  }
  if (state.nukeTimer[p] <= 0) {
    nukeExplode(p);
    return;
  }
  document.getElementById(`skill-label-p${p}`).textContent = `üí£ Meledak: ${state.nukeTimer[p]}s`;
  updateNukeTimerHUD(p);
  const pct = ((15 - state.nukeTimer[p]) / 15) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  state.nukeTimer[p]--;
  state.nukeInterval[p] = setTimeout(() => tickNuke(p), 1000);
}

function showNukeTimerHUD(p) {
  const existing = document.getElementById(`nuke-timer-${p}`);
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'nuke-timer';
  el.id = `nuke-timer-${p}`;
  el.style.left  = p === 1 ? '10px' : 'auto';
  el.style.right = p === 2 ? '10px' : 'auto';
  el.textContent = `üí£ P${p} MELEDAK: 15s`;
  document.getElementById('arena').appendChild(el);
}

function updateNukeTimerHUD(p) {
  const el = document.getElementById(`nuke-timer-${p}`);
  if (el) el.textContent = `üí£ P${p} MELEDAK: ${state.nukeTimer[p]}s`;
}

function nukeExplode(p) {
  if (state.gameOver) return;
  if (tryCounter(p)) {
    // Skill cancelled ‚Äî restart nuke timer
    addLog(`üí• LEDAKAN P${p} di-COUNTER! Nuke reset!`, 'special');
    startNukeTimer(p);
    return;
  }
  const el = document.getElementById(`nuke-timer-${p}`);
  if (el) el.remove();

  const target = p === 1 ? 2 : 1;
  const dmg = 55;

  addLog(`üí• PLAYER ${p} MELEDAK!`, 'special');
  doExplosion(p);
  mpBroadcastEvent('explosion', { p });

  setTimeout(() => {
    if (state.gameOver) return;
    // Lawan kena damage
    addLog(`Player ${target} kena ledakan ${dmg} damage!`, `p${target}`);
    dealDamage(target, dmg);
    // NUKE sendiri juga mati setelah ledakan
    setTimeout(() => {
      if (state.gameOver) return;
      addLog(`üíÄ Player ${p} mati terkena ledakannya sendiri!`, 'special');
      dealDamage(p, 9999); // instant death for bomb owner
    }, 200);
  }, 400);
}

function doExplosion(p) {
  const arena = document.getElementById('arena');
  const exp = document.createElement('div');
  exp.className = 'explosion';
  exp.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
  exp.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
  arena.appendChild(exp);
  setTimeout(() => exp.remove(), 700);

  const ball = document.getElementById(`ball-p${p}`);
  ball.style.transform = 'scale(2)';
  setTimeout(() => ball.style.transform = '', 300);
}

// =========== DOGE SKILL TIMER ===========
function startDogeSkillTimer(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  state.dogeSkillTimer[p] = 10;
  tickDoge(p);
}

function tickDoge(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  if (state.stunned[p]) {
    // paused ‚Äî check again in 200ms
    state.dogeSkillInterval[p] = setTimeout(() => tickDoge(p), 200);
    return;
  }
  if (state.dogeSkillTimer[p] <= 0) {
    activateDodge(p);
    return;
  }
  const pct = ((10 - state.dogeSkillTimer[p]) / 10) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üêï Dodge: ${state.dogeSkillTimer[p]}s`;
  state.dogeSkillTimer[p]--;
  state.dogeSkillInterval[p] = setTimeout(() => tickDoge(p), 1000);
}

function activateDodge(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  if (tryCounter(p)) {
    // Dodge cancelled ‚Äî restart doge timer
    addLog(`üêï Dodge P${p} di-COUNTER! Dodge batal!`, 'special');
    startDogeSkillTimer(p);
    return;
  }
  state.dodge[p] = true;

  const ball = document.getElementById(`ball-p${p}`);
  ball.style.outline = '3px solid var(--doge-color)';
  ball.style.boxShadow = '0 0 30px var(--doge-color)';

  addLog(`üêï Player ${p} siap DODGE tumbukan berikutnya!`, `p${p}`);
  document.getElementById(`skill-label-p${p}`).textContent = `üêï DODGE AKTIF!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  // After dodge is consumed or 5s max, restart cooldown
  state.dogeRestartTimeout[p] = setTimeout(() => {
    if (state.gameOver || state.chars[p] !== 'doge') return;
    state.dodge[p] = false;
    clearDodgeVisual(p);
    startDogeSkillTimer(p);
  }, 5000);
}

function clearDodgeVisual(p) {
  const ball = document.getElementById(`ball-p${p}`);
  ball.style.outline = '';
  ball.style.boxShadow = '';
}

// =========== THE WORLD SKILL TIMER ===========
function startWorldSkillTimer(p) {
  if (state.gameOver || state.chars[p] !== 'world') return;
  state.worldSkillTimer[p] = 14;
  tickWorld(p);
}

function tickWorld(p) {
  if (state.gameOver || state.chars[p] !== 'world') return;
  if (state.stunned[p]) {
    state.worldSkillInterval[p] = setTimeout(() => tickWorld(p), 200);
    return;
  }
  if (state.worldSkillTimer[p] <= 0) {
    activateWorldSkill(p);
    return;
  }
  const pct = ((14 - state.worldSkillTimer[p]) / 14) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üåç Za Warudo: ${state.worldSkillTimer[p]}s`;
  state.worldSkillTimer[p]--;
  state.worldSkillInterval[p] = setTimeout(() => tickWorld(p), 1000);
}

function activateWorldSkill(p) {
  if (state.gameOver) return;
  if (state.chars[p] !== 'world') return;
  if (tryCounter(p)) {
    addLog(`üåç ZA WARUDO P${p} di-COUNTER! Skill batal!`, 'special');
    startWorldSkillTimer(p);
    return;
  }
  const target = p === 1 ? 2 : 1;
  const stunDuration = 3000;

  addLog(`üåç ZA WARUDO! Player ${p} stop waktu! Player ${target} di-STUN!`, 'world');

  // Show dramatic effect
  const arena = document.getElementById('arena');

  const wf = document.createElement('div');
  wf.className = 'world-freeze';
  wf.id = 'world-freeze';
  arena.appendChild(wf);

  const wt = document.createElement('div');
  wt.className = 'world-text';
  wt.id = 'world-text';
  wt.textContent = 'ZA WARUDO!';
  arena.appendChild(wt);

  setTimeout(() => { wt.remove(); }, 1200);
  setTimeout(() => { wf.remove(); }, stunDuration);

  // Stun target ‚Äî POHON is immune!
  if (state.chars[target] === 'pohon') {
    addLog(`üå¥ POHON P${target} IMMUNE! ZA WARUDO ga mempan!`, 'special');
    state.worldRestartTimeout[p] = setTimeout(() => {
      if (!state.gameOver && state.chars[p] === 'world') startWorldSkillTimer(p);
    }, stunDuration + 100);
    return;
  }
  state.stunned[target] = true;

  // Pause all skill timers of the stunned player
  clearInterval(state.nukeInterval[target]);
  clearInterval(state.dogeSkillInterval[target]);
  clearInterval(state.worldSkillInterval[target]);

  // Show stun stars
  const stars = document.createElement('div');
  stars.className = 'stun-stars';
  stars.id = `stun-stars-${target}`;
  stars.textContent = '‚≠êüí´‚≠ê';
  arena.appendChild(stars);

  document.getElementById(`ball-p${target}`).classList.add('stunned');

  if (state.stunTimeout[target]) clearTimeout(state.stunTimeout[target]);
  state.stunTimeout[target] = setTimeout(() => {
    if (state.gameOver) return;
    state.stunned[target] = false;
    document.getElementById(`ball-p${target}`).classList.remove('stunned');
    const s = document.getElementById(`stun-stars-${target}`);
    if (s) s.remove();
    addLog(`Player ${target} bebas dari stun! Skill timer lanjut!`, `p${target}`);

    // Tick functions auto-resume since they check state.stunned[p]
    // Just need to kick off the tick again
    const ch = state.chars[target];
    if (ch === 'nuke') state.nukeInterval[target] = setTimeout(() => tickNuke(target), 200);
    else if (ch === 'doge') {
      if (state.dodge[target]) {
        // was in dodge-active window, let dogeRestartTimeout handle it
      } else {
        state.dogeSkillInterval[target] = setTimeout(() => tickDoge(target), 200);
      }
    }
    else if (ch === 'world') state.worldSkillInterval[target] = setTimeout(() => tickWorld(target), 200);
  }, stunDuration);

  document.getElementById(`skill-label-p${p}`).textContent = `üåç ZA WARUDO AKTIF!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  // Restart cooldown after stun duration
  state.worldRestartTimeout[p] = setTimeout(() => {
    if (!state.gameOver && state.chars[p] === 'world') startWorldSkillTimer(p);
  }, stunDuration + 100);
}

// =========== RESUME TIMERS AFTER STUN ===========
// No longer needed ‚Äî tickX functions handle pausing automatically via stunned check

// (Resume functions removed ‚Äî tick functions handle auto-resume via stunned check)

// =========== MADE IN HEAVEN TIMER ===========
function startMihTimer(p) {
  if (state.gameOver || state.chars[p] !== 'mih') return;
  tickMih(p, 12);
}

function tickMih(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'mih') return;
  if (state.stunned[p]) {
    state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, remaining), 200);
    return;
  }
  if (remaining <= 0) {
    if (tryCounter(p)) {
      addLog(`‚ö° Speed Up P${p} di-COUNTER! Kecepatan batal nambah!`, 'special');
      state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, 12), 500);
      return;
    }
    // Speed up!
    state.mihSpeed[p] = Math.min(state.mihSpeed[p] + 2.5, 28); // cap at 28
    const ball = document.getElementById(`ball-p${p}`);
    ball.classList.add('mih-active');
    addLog(`‚ö° MADE IN HEAVEN P${p}! Kecepatan ${state.mihSpeed[p].toFixed(1)}!`, 'special');
    document.getElementById(`skill-label-p${p}`).textContent = `‚ö° SPEED: ${state.mihSpeed[p].toFixed(1)}x`;
    document.getElementById(`cd-p${p}`).style.width = '100%';
    // Flash effect
    setTimeout(() => document.getElementById(`cd-p${p}`).style.width = '0%', 300);
    // Start next cycle
    state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, 12), 500);
    return;
  }
  const pct = ((12 - remaining) / 12) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `‚ö° Speed up: ${remaining}s`;
  state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, remaining - 1), 1000);
}

// =========== DAMAGE ===========
function dealDamage(target, dmg, attacker) {
  if (state.gameOver) return;
  // MiH: 15% damage reduction
  if (state.chars[target] === 'mih') {
    dmg = Math.floor(dmg * 0.85);
  }
  // THE WRITER: 20% damage reduction
  if (state.writerDmgReduce[target]) {
    dmg = Math.floor(dmg * 0.80);
  }
  // TANK: armor reduces all incoming damage to 1-2 (unless stunned)
  // Counter pierces armor (x3), div2 passive bypasses armor, everything else capped at 1-2
  if (state.chars[target] === 'tank' && !state.stunned[target] && !(attacker && state.chars[attacker] === 'div2')) {
    if (attacker && state.chars[attacker] === 'counter') {
      dmg = dmg * 3;
      addLog('üõ°Ô∏è COUNTER hancurin armor TANK P' + target + '! kena ' + dmg + ' dmg!', 'special');
    } else {
      dmg = Math.floor(Math.random() * 2) + 1;
      addLog('ü™© TANK P' + target + ' armor: cuma kena ' + dmg + ' dmg!', 'p' + target);
    }
  } else if (attacker) {
    // Log normal collision damage after all reductions applied
    const atkChar = state.chars[attacker];
    if (state.stunned[target]) {
      addLog('üí• STUN BONUS! P' + target + ' kena ' + dmg + ' dmg (x3)!', 'world');
    } else if (atkChar === 'mih') {
      addLog('‚ö° MiH serang! P' + target + ' kena ' + dmg + ' dmg!', 'p' + attacker);
    } else {
      addLog('üí• Tumbukan! P' + target + ' kena ' + dmg + ' dmg!', 'p' + target);
    }
  }

  state.hp[target] = Math.max(0, state.hp[target] - dmg);
  updateHpBar(target);
  showDamagePopup(target, dmg);
  mpBroadcastEvent('hit', { target, dmg, hp1: state.hp[1], hp2: state.hp[2] });

  const ball = document.getElementById(`ball-p${target}`);
  ball.classList.add('hit');
  setTimeout(() => ball.classList.remove('hit'), 400);

  if (state.hp[target] <= 0) {
    // UNDEATH: revive sekali
    if (state.chars[target] === 'undeath' && !state.undeathRevived[target]) {
      state.undeathRevived[target] = true;
      state.hp[target] = 0;
      updateHpBar(target);
      setTimeout(() => triggerUndeathRevive(target), 300);
      return;
    }
    // Guest mode: jangan putuskan pemenang sendiri ‚Äî tunggu keputusan HOST
    if (gameMode === 'multiplayer' && mpRole === 'guest') {
      // Tetap jalankan visuals tapi jangan panggil endGame
      state.hp[target] = 0;
      updateHpBar(target);
      return;
    }
    // Cek seri: kalau lawan juga HP 0 (misal nuke bunuh dua-duanya)
    const opp = target === 1 ? 2 : 1;
    if (state.hp[opp] <= 0) {
      // Kedua mati ‚Äî seri!
      state.gameOver = true;
      cancelAnimationFrame(state.rafId);
      addLog('üíÄ Kedua player mati! SERI!', 'special');
      if (gameMode === 'multiplayer' && mpRole === 'host') {
        mpSend({ type: 'game_result', draw: true });
      }
      setTimeout(() => showDrawNotif(), 300);
      return;
    }
    endGame(target === 1 ? 2 : 1);
  }
}

// =========== UNDEATH REVIVE ===========
function triggerUndeathRevive(p) {
  if (state.gameOver) return;
  const roll = Math.random() * 100;
  let hpGain, label;
  if (roll < 60) {
    hpGain = Math.floor(state.maxHp[p] * 0.10);
    label = 'BANGKIT 10%!';
  } else if (roll < 90) {
    hpGain = Math.floor(state.maxHp[p] * 0.20);
    label = 'BANGKIT 20%!';
  } else {
    hpGain = state.maxHp[p];
    label = 'BANGKIT 100%!';
  }
  state.hp[p] = Math.min(hpGain, state.maxHp[p]);
  updateHpBar(p);
  mpBroadcastEvent('undeath_revive', { target: p, newHp: state.hp[p] });

  // Revive animation on ball
  const ball = document.getElementById(`ball-p${p}`);
  ball.classList.add('undeath-reviving');
  setTimeout(() => ball.classList.remove('undeath-reviving'), 1800);

  // Revive text popup
  const arena = document.getElementById('arena');
  const txt = document.createElement('div');
  txt.className = 'undeath-revive-text';
  txt.textContent = 'üíÄ ' + label;
  txt.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
  txt.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
  arena.appendChild(txt);
  setTimeout(() => txt.remove(), 1400);

  document.getElementById(`skill-label-p${p}`).textContent = 'üíÄ REVIVE: SUDAH DIPAKAI';
  document.getElementById(`cd-p${p}`).style.width = '0%';
  addLog(`üíÄ UNDEATH P${p} BANGKIT! HP +${hpGain} (${label})`, 'special');
}

function updateHpBar(p) {
  const pct = (state.hp[p] / state.maxHp[p]) * 100;
  document.getElementById(`hp-bar-p${p}`).style.width = Math.max(0, pct) + '%';
  document.getElementById(`hp-text-p${p}`).textContent = `${Math.max(0, state.hp[p])} HP`;
}

function showDamagePopup(target, dmg) {
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'dmg-popup';
  el.textContent = `-${dmg}`;
  el.style.color = target === 1 ? 'var(--p1)' : 'var(--p2)';
  el.style.left = (state.pos[target].x + BALL_SIZE/2) + 'px';
  el.style.top  = (state.pos[target].y) + 'px';
  arena.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

function showMiss(target) {
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'dmg-miss';
  el.textContent = 'DODGE!';
  el.style.left = (state.pos[target].x + BALL_SIZE/2) + 'px';
  el.style.top  = (state.pos[target].y) + 'px';
  arena.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

// =========== LOG ===========
function addLog(msg, cls = '') {
  const inner = document.getElementById('log-inner');
  const el = document.createElement('div');
  el.className = `log-entry ${cls}`;
  el.textContent = msg;
  inner.insertBefore(el, inner.firstChild);
  while (inner.children.length > 8) inner.removeChild(inner.lastChild);
}


// =========== POHON SKILL TIMER ===========
function startPohonTimer(p) {
  if (state.gameOver || state.chars[p] !== 'pohon') return;
  tickPohon(p, 5);
}

function tickPohon(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'pohon') return;
  // POHON is immune to stun, so no stunned check here!
  if (remaining <= 0) {
    spawnPohonTree(p);
    state.pohonSkillInterval[p] = setTimeout(() => tickPohon(p, 5), 500);
    return;
  }
  const pct = ((5 - remaining) / 5) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üå¥ Pohon: ${remaining}s`;
  state.pohonSkillInterval[p] = setTimeout(() => tickPohon(p, remaining - 1), 1000);
}

function spawnPohonTree(p) {
  if (state.gameOver) return;
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'pohon-tree';
  el.textContent = 'üå¥';

  // Start at player center
  const startX = state.pos[p].x + BALL_SIZE / 2;
  const startY = state.pos[p].y + BALL_SIZE / 2;

  // Aim toward opponent current position
  const opp = p === 1 ? 2 : 1;
  const targetX = state.pos[opp].x + BALL_SIZE / 2;
  const targetY = state.pos[opp].y + BALL_SIZE / 2;
  const dx = targetX - startX;
  const dy = targetY - startY;
  const dist = Math.sqrt(dx*dx + dy*dy) || 1;
  const speed = 7;
  const vx = (dx / dist) * speed;
  const vy = (dy / dist) * speed;

  el.style.left = startX + 'px';
  el.style.top  = startY + 'px';
  arena.appendChild(el);

  addLog(`üå¥ POHON P${p} lempar pohon ke P${opp}!`, `p${p}`);
  document.getElementById(`skill-label-p${p}`).textContent = `üå¥ POHON TERBANG!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  const treeData = { x: startX, y: startY, vx, vy, owner: p, el, timeout: null, hit: false };
  state.pohonTrees.push(treeData);

  // Auto-remove after 3 seconds if no hit
  treeData.timeout = setTimeout(() => {
    if (el.parentNode) el.parentNode.removeChild(el);
    const idx = state.pohonTrees.indexOf(treeData);
    if (idx !== -1) state.pohonTrees.splice(idx, 1);
  }, 3000);
}

function checkPohonTrees() {
  if (state.pohonTrees.length === 0) return;

  for (let i = state.pohonTrees.length - 1; i >= 0; i--) {
    const tree = state.pohonTrees[i];
    if (!tree.el || !tree.el.parentNode || tree.hit) continue;

    // Move tree
    tree.x += tree.vx;
    tree.y += tree.vy;
    tree.el.style.left = tree.x + 'px';
    tree.el.style.top  = tree.y + 'px';

    // Check collision with opponent only (not self)
    const target = tree.owner === 1 ? 2 : 1;
    const bx = state.pos[target].x + BALL_SIZE / 2;
    const by = state.pos[target].y + BALL_SIZE / 2;
    const dist = Math.sqrt((bx - tree.x) ** 2 + (by - tree.y) ** 2);

    if (dist < BALL_SIZE * 0.85) {
      tree.hit = true;
      clearTimeout(tree.timeout);
      // Hit animation then remove
      tree.el.style.animation = 'treeHit 0.3s ease-out forwards';
      setTimeout(() => {
        if (tree.el.parentNode) tree.el.parentNode.removeChild(tree.el);
      }, 300);
      state.pohonTrees.splice(i, 1);
      // Deal 5 damage
      const dmg = 5;
      addLog(`üå¥ Pohon kena P${target}! -${dmg} HP!`, 'special');
      dealDamage(target, dmg);
    }
  }
}

// =========== JHON SKILL TIMER ===========
function startJhonTimer(p) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  tickJhon(p, 10);
}

function tickJhon(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  if (state.stunned[p]) {
    state.jhonSkillInterval[p] = setTimeout(() => tickJhon(p, remaining), 200);
    return;
  }
  if (remaining <= 0) {
    activateJhonSkill(p);
    return;
  }
  const pct = ((10 - remaining) / 10) * 100;
  document.getElementById('cd-p' + p).style.width = pct + '%';
  document.getElementById('skill-label-p' + p).textContent = 'üí° Flash: ' + remaining + 's';
  state.jhonSkillInterval[p] = setTimeout(() => tickJhon(p, remaining - 1), 1000);
}

function activateJhonSkill(p) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  if (tryCounter(p)) {
    addLog('üí° Flash JHON P' + p + ' di-COUNTER! Skill batal!', 'special');
    startJhonTimer(p);
    return;
  }
  const target = p === 1 ? 2 : 1;
  addLog('üí° JHON P' + p + ' tembak cahaya! P' + target + ' BUTA & STUN!', 'special');

  // Flash seluruh arena
  const arena = document.getElementById('arena');
  const flashEl = document.createElement('div');
  flashEl.className = 'jhon-flash';
  arena.appendChild(flashEl);
  setTimeout(() => flashEl.remove(), 500);

  document.getElementById('skill-label-p' + p).textContent = 'üí° FLASH AKTIF!';
  document.getElementById('cd-p' + p).style.width = '100%';

  // Stun target 2 detik (kecuali pohon immune)
  if (state.chars[target] === 'pohon') {
    addLog('üå¥ POHON P' + target + ' IMMUNE! Flash ga mempan!', 'special');
  } else {
    // Stun 2 detik
    state.stunned[target] = true;
    const ball = document.getElementById('ball-p' + target);
    ball.classList.add('stunned');
    mpBroadcastEvent('stun_on', { target });

    const stars = document.createElement('div');
    stars.className = 'stun-stars';
    stars.id = 'stun-stars-' + target;
    stars.textContent = '‚≠êüí°‚≠ê';
    arena.appendChild(stars);

    if (state.stunTimeout[target]) clearTimeout(state.stunTimeout[target]);
    state.stunTimeout[target] = setTimeout(() => {
      if (state.gameOver) return;
      state.stunned[target] = false;
      ball.classList.remove('stunned');
      const s = document.getElementById('stun-stars-' + target);
      if (s) s.remove();
      mpBroadcastEvent('stun_off', { target });
      addLog('P' + target + ' bebas dari stun JHON!', 'p' + target);
      // Lanjutkan skill timer karakter target setelah stun
      const ch = state.chars[target];
      if (ch === 'nuke')  state.nukeInterval[target] = setTimeout(() => tickNuke(target), 200);
      else if (ch === 'doge' && !state.dodge[target]) state.dogeSkillInterval[target] = setTimeout(() => tickDoge(target), 200);
      else if (ch === 'world') state.worldSkillInterval[target] = setTimeout(() => tickWorld(target), 200);
      else if (ch === 'jhon') state.jhonSkillInterval[target] = setTimeout(() => tickJhon(target, 0), 200);
    }, 2000);

    // Slow 5% selama 4 detik
    if (state.jhonSlowTimeout[target]) clearTimeout(state.jhonSlowTimeout[target]);
    state.jhonSlowed[target] = true;

    // Tambah slow ring visual di bola target
    const existRing = document.getElementById('jhon-slow-ring-' + target);
    if (existRing) existRing.remove();
    const ring = document.createElement('div');
    ring.className = 'jhon-slow-ring';
    ring.id = 'jhon-slow-ring-' + target;
    ring.style.width  = (BALL_SIZE + 16) + 'px';
    ring.style.height = (BALL_SIZE + 16) + 'px';
    ring.style.left   = (state.pos[target].x + BALL_SIZE/2) + 'px';
    ring.style.top    = (state.pos[target].y + BALL_SIZE/2) + 'px';
    arena.appendChild(ring);
    addLog('üí° P' + target + ' di-SLOW 5% selama 4 detik!', 'special');

    state.jhonSlowTimeout[target] = setTimeout(() => {
      if (state.gameOver) return;
      state.jhonSlowed[target] = false;
      const r = document.getElementById('jhon-slow-ring-' + target);
      if (r) r.remove();
      addLog('P' + target + ' bebas dari slow JHON!', 'p' + target);
    }, 4000);
  }

  // Restart cooldown
  setTimeout(() => startJhonTimer(p), 500);
}

// =========== THE WRITER SKILL TIMER ===========
function startWriterTimer(p) {
  if (state.gameOver || state.chars[p] !== 'writer') return;
  tickWriter(p, 17);
}

function tickWriter(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'writer') return;
  if (state.stunned[p]) {
    state.writerSkillInterval[p] = setTimeout(() => tickWriter(p, remaining), 200);
    return;
  }
  if (remaining <= 0) {
    openWriterModal(p);
    return;
  }
  const pct = ((17 - remaining) / 17) * 100;
  document.getElementById('cd-p' + p).style.width = pct + '%';
  document.getElementById('skill-label-p' + p).textContent = '‚úèÔ∏è Write: ' + remaining + 's';
  state.writerSkillInterval[p] = setTimeout(() => tickWriter(p, remaining - 1), 1000);
}

function openWriterModal(p) {
  if (state.gameOver) return;
  // Pause game loop visually (don't cancel raf, just flag)
  state.writerPendingPlayer = p;
  document.getElementById('writer-modal-sub').textContent = 'PLAYER ' + p + ' ‚Äî PILIH EFEK';
  document.getElementById('writer-overlay').classList.add('show');
  document.getElementById('skill-label-p' + p).textContent = '‚úèÔ∏è PILIH EFEK!';
  document.getElementById('cd-p' + p).style.width = '100%';
  addLog('‚úèÔ∏è THE WRITER P' + p + ' pilih efek!', 'special');
}

function writerChoose(choice) {
  const p = state.writerPendingPlayer;
  if (!p || state.gameOver) return;
  document.getElementById('writer-overlay').classList.remove('show');
  const target = p === 1 ? 2 : 1;

  if (choice === 1) {
    // -50 HP lawan
    addLog('‚úèÔ∏è WRITER P' + p + ' tulis: P' + target + ' kehilangan 50 HP!', 'special');
    dealDamage(target, 50);
  } else if (choice === 2) {
    // +20 HP diri sendiri
    const healed = Math.min(20, state.maxHp[p] - state.hp[p]);
    state.hp[p] = Math.min(state.hp[p] + 20, state.maxHp[p]);
    updateHpBar(p);
    addLog('‚úèÔ∏è WRITER P' + p + ' tulis: +' + healed + ' HP pulih!', 'special');
    // Heal popup
    const arena = document.getElementById('arena');
    const pop = document.createElement('div');
    pop.className = 'dmg-popup';
    pop.textContent = '+' + healed + ' HP';
    pop.style.color = '#00ff88';
    pop.style.left = (state.pos[p].x + 30) + 'px';
    pop.style.top  = state.pos[p].y + 'px';
    arena.appendChild(pop);
    setTimeout(() => pop.remove(), 900);
  } else if (choice === 3) {
    // Uncounter
    state.writerUncounter[p] = true;
    addLog('‚úèÔ∏è WRITER P' + p + ' tulis: Tumbukan berikutnya UNCOUNTER!', 'special');
    document.getElementById('skill-label-p' + p).textContent = '‚úèÔ∏è UNCOUNTER AKTIF!';
  } else if (choice === 4) {
    // Damage reduce 20% selama 10 detik
    state.writerDmgReduce[p] = true;
    if (state.writerDmgReduceTimeout[p]) clearTimeout(state.writerDmgReduceTimeout[p]);
    state.writerDmgReduceTimeout[p] = setTimeout(() => {
      state.writerDmgReduce[p] = false;
      if (!state.gameOver) {
        addLog('‚úèÔ∏è Damage Reduce P' + p + ' habis!', 'p' + p);
        document.getElementById('skill-label-p' + p).textContent = '‚úèÔ∏è Write: Ready';
      }
    }, 10000);
    addLog('‚úèÔ∏è WRITER P' + p + ' tulis: Damage Reduce 20% aktif 10 detik!', 'special');
    document.getElementById('skill-label-p' + p).textContent = '‚úèÔ∏è DMG REDUCE AKTIF!';
  }

  state.writerPendingPlayer = 0;
  // Restart cooldown (only if not damage reduce which updates label itself)
  setTimeout(() => startWriterTimer(p), 300);
}

// =========== SECRET UNLOCK (SAWIT + DEVLO) ===========
let pohonUnlocked = false;
let jhonUnlocked = false;
const SECRET_CODE = 'SAWIT';
const SECRET_CODE_JHON = 'DEVLO';

(function setupSecretInputs() {
  const digits = Array.from({length: 5}, (_, i) => document.getElementById('sd' + i));

  digits.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const val = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
      e.target.value = val.slice(-1);
      if (val) {
        // Auto-advance to next
        if (idx < 4) digits[idx + 1].focus();
        checkSecretCode(digits);
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && idx > 0) {
        digits[idx - 1].focus();
        digits[idx - 1].value = '';
      }
    });

    // Prevent non-alpha
    input.addEventListener('keypress', (e) => {
      if (!/[a-zA-Z]/.test(e.key)) e.preventDefault();
    });
  });
})();

function checkSecretCode(digits) {
  const entered = digits.map(d => d.value.toUpperCase()).join('');
  if (entered.length < 5) return;

  if (entered === SECRET_CODE) {
    digits.forEach(d => d.classList.add('correct'));
    if (!pohonUnlocked) {
      pohonUnlocked = true;
      setTimeout(unlockPohon, 400);
    }
  } else if (entered === SECRET_CODE_JHON) {
    digits.forEach(d => d.classList.add('correct'));
    if (!jhonUnlocked) {
      jhonUnlocked = true;
      setTimeout(unlockJhon, 400);
    }
  } else if (entered.length === 5) {
    digits.forEach(d => d.classList.add('wrong'));
    setTimeout(() => {
      digits.forEach(d => { d.classList.remove('wrong'); d.value = ''; });
      digits[0].focus();
    }, 600);
  }
}

function unlockJhon() {
  document.getElementById('jhon-card-p1').style.display = '';
  document.getElementById('jhon-card-p2').style.display = '';
  document.getElementById('writer-card-p1').style.display = '';
  document.getElementById('writer-card-p2').style.display = '';

  const label = document.querySelector('.secret-label');
  if (label) { label.textContent = 'üí°‚úèÔ∏è Kode Benar! JHON & THE WRITER Terbuka!'; label.style.color = '#ffe066'; }

  const notif = document.createElement('div');
  notif.className = 'secret-unlock';
  notif.style.color = '#ffe066';
  notif.style.borderColor = '#ffe066';
  notif.style.textShadow = '0 0 40px #ffe066, 0 0 80px #ffcc00';
  notif.innerHTML = 'üí° JHON & THE WRITER UNLOCKED! ‚úèÔ∏è<small>2 Karakter Rahasia Terbuka!</small>';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

function unlockPohon() {
  // Show both pohon cards
  document.getElementById('pohon-card-p1').style.display = '';
  document.getElementById('pohon-card-p2').style.display = '';

  // Update label
  const label = document.querySelector('.secret-label');
  if (label) { label.textContent = 'üå¥ Kode Benar! POHON Terbuka!'; label.style.color = '#00ff44'; }

  // Show dramatic unlock notification
  const notif = document.createElement('div');
  notif.className = 'secret-unlock';
  notif.innerHTML = 'üå¥ POHON UNLOCKED! üå¥<small>Karakter Rahasia Terbuka!</small>';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// =========== JUDGE WINNER ===========
function judgeWinner() {
  if (state.gameOver) return;
  // Guest tidak berhak memutuskan pemenang ‚Äî host yang otoritas
  if (gameMode === 'multiplayer' && mpRole === 'guest') return;
  document.getElementById('speed-btn-wrap').style.display = 'none';

  const hp1 = state.hp[1];
  const hp2 = state.hp[2];

  if (hp1 === hp2) {
    // SERI
    addLog('ü§ù HP sama! SERI!', 'special');
    if (gameMode === 'multiplayer' && mpRole === 'host') {
      mpSend({ type: 'game_result', draw: true });
    }
    showDrawNotif();
    // End game manually without winner
    state.gameOver = true;
    cancelAnimationFrame(state.rafId);
    if (state.battleTimer) clearTimeout(state.battleTimer);
    [1, 2].forEach(p => {
      clearTimeout(state.nukeInterval[p]);
      clearTimeout(state.dogeSkillInterval[p]);
      clearTimeout(state.worldSkillInterval[p]);
      clearTimeout(state.skillCdInterval[p]);
      clearTimeout(state.jhonSkillInterval[p]);
      clearTimeout(state.jhonSlowTimeout[p]);
      if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
      if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    });
  } else {
    const winner = hp1 > hp2 ? 1 : 2;
    const loser  = winner === 1 ? 2 : 1;
    addLog(`üèÜ P${winner} menang! HP ${state.hp[winner]} vs ${state.hp[loser]}!`, 'special');
    endGame(winner);
  }
}

function showDrawNotif() {
  const notif = document.createElement('div');
  notif.className = 'draw-notif';
  notif.innerHTML = 'ü§ù SERI! ü§ù<small>HP kedua player sama!</small>';
  document.body.appendChild(notif);
  setTimeout(() => {
    notif.remove();
    // Show replay option - reuse win overlay
    const wBox = document.getElementById('win-box');
    wBox.style.borderColor = '#ffd700';
    wBox.style.boxShadow = '0 0 60px rgba(255,215,0,0.33)';
    document.getElementById('win-char').textContent = 'ü§ù';
    document.getElementById('win-title').textContent = 'SERI!';
    document.getElementById('win-title').style.color = '#ffd700';
    document.getElementById('win-msg').textContent = 'Kedua player memiliki HP yang sama!';
    document.getElementById('win-overlay').classList.add('show');
  }, 2500);
}

// =========== END GAME ===========
function endGame(winner) {
  state.gameOver = true;
  cancelAnimationFrame(state.rafId);
  if (state.battleTimer) clearTimeout(state.battleTimer);
  document.getElementById('speed-btn-wrap').style.display = 'none';

  // HOST = authority: kirim hasil ke guest agar pemenang sama
  if (gameMode === 'multiplayer' && mpRole === 'host') {
    mpSend({ type: 'game_result', winner: winner, draw: false });
  }

  [1, 2].forEach(p => {
    clearInterval(state.nukeInterval[p]);
    clearInterval(state.dogeSkillInterval[p]);
    clearInterval(state.worldSkillInterval[p]);
    clearInterval(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();
    if (state.writerSkillInterval[p]) clearTimeout(state.writerSkillInterval[p]);
    if (state.writerDmgReduceTimeout[p]) clearTimeout(state.writerDmgReduceTimeout[p]);
    state.writerUncounter[p] = false;
    state.writerDmgReduce[p] = false;
    const el = document.getElementById(`nuke-timer-${p}`);
    if (el) el.remove();
    document.getElementById(`ball-p${p}`)?.classList.remove('counter-clash', 'mih-active', 'stunned');
    const stars = document.getElementById(`stun-stars-${p}`);
    if (stars) stars.remove();
  });

  // Clear pohon trees
  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];

  const wf = document.getElementById('world-freeze');
  if (wf) wf.remove();
  const wt = document.getElementById('world-text');
  if (wt) wt.remove();

  const winChar = state.chars[winner];
  const wBox = document.getElementById('win-box');
  const winColor = winner === 1 ? '#00e5ff' : '#ff4444';
  wBox.style.borderColor = winColor;
  wBox.style.boxShadow = `0 0 60px ${winColor}33`;

  document.getElementById('win-char').textContent = charData[winChar].icon;
  document.getElementById('win-title').textContent = `PLAYER ${winner}`;
  document.getElementById('win-title').style.color = winColor;
  document.getElementById('win-msg').textContent = `${charData[winChar].name} menang! Player ${winner === 1 ? 2 : 1} kalah!`;
  document.getElementById('win-overlay').classList.add('show');

  for (let i = 0; i < 60; i++) {
    setTimeout(() => spawnConfetti(winColor), i * 40);
  }
}

function spawnConfetti(baseColor) {
  const colors = [baseColor, '#fff', '#ffd700', '#ff88ff', '#88ffff'];
  const el = document.createElement('div');
  el.className = 'confetti-piece';
  el.style.left = Math.random() * 100 + 'vw';
  el.style.background = colors[Math.floor(Math.random() * colors.length)];
  el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
  el.style.animationDelay = Math.random() * 0.5 + 's';
  el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// =========== REPLAY ===========
function replay() {
  [1, 2].forEach(p => {
    clearTimeout(state.nukeInterval[p]);
    clearTimeout(state.dogeSkillInterval[p]);
    clearTimeout(state.worldSkillInterval[p]);
    clearTimeout(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.worldRestartTimeout[p]) clearTimeout(state.worldRestartTimeout[p]);
    if (state.dogeRestartTimeout[p]) clearTimeout(state.dogeRestartTimeout[p]);
    if (state.mihRestartTimeout[p]) clearTimeout(state.mihRestartTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();
    if (state.writerSkillInterval[p]) clearTimeout(state.writerSkillInterval[p]);
    if (state.writerDmgReduceTimeout[p]) clearTimeout(state.writerDmgReduceTimeout[p]);
    state.writerUncounter[p] = false;
    state.writerDmgReduce[p] = false;
  });
  cancelAnimationFrame(state.rafId);

  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];
  state.chars = { 1: null, 2: null };
  document.querySelectorAll('.char-card').forEach(c => {
    c.classList.remove('selected-nuke', 'selected-doge', 'selected-world', 'selected-mih', 'selected-counter', 'selected-tank', 'selected-pohon', 'selected-div2', 'selected-undeath', 'selected-jhon', 'selected-writer');
  });
  document.getElementById('win-overlay').classList.remove('show');

  if (gameMode === 'multiplayer') {
    cancelRoom();
    showPage('menu');
  } else {
    startSingleplayer();
  }
}

// showPage needs to handle new page IDs


function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + name);
  if (el) el.classList.add('active');
}

// =========== MAIN MENU ===========
function startSingleplayer() {
  gameMode = 'singleplayer';
  state.chars = { 1: null, 2: null };
  document.querySelectorAll('.char-card').forEach(c => {
    c.classList.remove(...UNSELECT_CLASSES);
    c.style.pointerEvents = '';
  });
  // Reset previews
  [1,2].forEach(p => {
    const e = document.getElementById('sp-emoji-p' + p);
    const n = document.getElementById('sp-name-p' + p);
    const d = document.getElementById('sp-desc-p' + p);
    const t = document.getElementById('sp-tag-p' + p);
    if (e) e.textContent = '‚ùì';
    if (n) { n.textContent = 'PILIH KARAKTER'; n.style.color = '#222'; }
    if (d) d.innerHTML = '<span class="sp-char-placeholder">Sentuh karakter di bawah</span>';
    if (t) t.textContent = '';
  });
  // Reset confirm buttons
  const b1 = document.getElementById('sp-confirm-p1');
  const b2 = document.getElementById('sp-confirm-p2');
  if (b1) { b1.disabled = true; b1.textContent = 'KONFIRMASI'; }
  if (b2) { b2.disabled = true; b2.textContent = 'KONFIRMASI'; }

  document.getElementById('mp-role-badge-wrap').style.display = 'none';
  const _mcb = document.getElementById('mp-char-confirm-btn'); if(_mcb) _mcb.style.display = 'none';
  const mch = document.getElementById('mp-char-hint'); if (mch) mch.style.display = 'none';
  const mw = document.getElementById('mp-waiting-char'); if (mw) mw.classList.remove('show');
  showPage('select-p1');
}

function backToMenu() {
  cancelRoom();
  showPage('menu');
}

// =========== PEERJS MULTIPLAYER ===========
// Menggunakan PeerJS (WebRTC) untuk komunikasi P2P lintas perangkat
let mpPeer = null;      // instance PeerJS
let mpConn = null;      // koneksi P2P aktif
let mpHostChar = null;
let mpGuestChar = null;
let mpBattleStarted = false;

// Load PeerJS dari CDN
function loadPeerJS(callback) {
  if (window.Peer) { callback(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js';
  s.onload = callback;
  s.onerror = () => {
    alert('Gagal memuat library PeerJS. Periksa koneksi internet Anda.');
  };
  document.head.appendChild(s);
}

// Kirim pesan ke peer
function mpSend(msg) {
  if (mpConn && mpConn.open) {
    try { mpConn.send(msg); } catch(e) { console.error('mpSend error', e); }
  }
}

// Broadcast skill event ke guest (hanya host yang panggil ini)
function mpBroadcastEvent(evtType, data = {}) {
  if (gameMode === 'multiplayer' && mpRole === 'host') {
    mpSend({ type: 'skill_event', evt: evtType, ...data });
  }
}

// Handle pesan masuk dari peer
function onMpMessage(msg) {
  if (!msg || !msg.type) return;

  if (msg.type === 'guest_ready') {
    // Host menerima: guest sudah siap (sudah join)
    if (mpRole === 'host') {
      enterMpSelect('host', mpRoomCode);
    }
  }

  if (msg.type === 'char_selected') {
    // Salah satu pihak konfirmasi karakter
    if (mpRole === 'host') {
      // Kita host, menerima pilihan guest (player 2)
      mpGuestChar = msg.char;
    } else {
      // Kita guest, menerima pilihan host (player 1)
      mpHostChar = msg.char;
    }
    checkBothCharReady();
  }

  if (msg.type === 'start_battle') {
    // Host mengirim sinyal start ke guest
    if (mpRole === 'guest') {
      mpHostChar = msg.host_char;
      mpGuestChar = msg.guest_char;
      startMpBattle();
    }
  }

  // ===== SKILL EVENT VISUAL dari HOST =====
  if (msg.type === 'skill_event' && mpRole === 'guest') {
    const { evt, p, target, dmg, hp1, hp2 } = msg;
    // Sync HP jika dikirim
    if (hp1 !== undefined && hp1 !== state.hp[1]) { state.hp[1] = hp1; updateHpBar(1); }
    if (hp2 !== undefined && hp2 !== state.hp[2]) { state.hp[2] = hp2; updateHpBar(2); }

    if (evt === 'explosion') { doExplosion(p); }
    if (evt === 'stun_on') {
      state.stunned[target] = true;
      const b = document.getElementById('ball-p' + target);
      if (b) b.classList.add('stunned');
    }
    if (evt === 'stun_off') {
      state.stunned[target] = false;
      const b = document.getElementById('ball-p' + target);
      if (b) b.classList.remove('stunned');
      const s = document.getElementById('stun-stars-' + target); if (s) s.remove();
    }
    if (evt === 'collision_flash') {
      const arena = document.getElementById('arena');
      const flash = document.createElement('div');
      flash.className = 'collision-flash';
      flash.style.left = msg.cx + 'px'; flash.style.top = msg.cy + 'px';
      arena.appendChild(flash);
      setTimeout(() => flash.remove(), 400);
    }
    if (evt === 'hit') {
      const b = document.getElementById('ball-p' + target);
      if (b) { b.classList.add('hit'); setTimeout(() => b.classList.remove('hit'), 400); }
      if (dmg !== undefined) showDamagePopup(target, dmg);
    }
    if (evt === 'dodge') { showMiss(target); }
    if (evt === 'undeath_revive') {
      state.hp[target] = msg.newHp;
      updateHpBar(target);
      const b = document.getElementById('ball-p' + target);
      if (b) { b.classList.add('undeath-reviving'); setTimeout(() => b.classList.remove('undeath-reviving'), 1800); }
    }
    return;
  }

  // ===== STATE SYNC dari HOST =====
  if (msg.type === 'state_sync' && mpRole === 'guest') {
    // Terapkan state dari host langsung
    state.pos[1].x = msg.pos1.x; state.pos[1].y = msg.pos1.y;
    state.vel[1].x = msg.vel1.x; state.vel[1].y = msg.vel1.y;
    state.pos[2].x = msg.pos2.x; state.pos[2].y = msg.pos2.y;
    state.vel[2].x = msg.vel2.x; state.vel[2].y = msg.vel2.y;
    state.stunned[1] = msg.stunned1;
    state.stunned[2] = msg.stunned2;

    // Update HP
    if (msg.hp1 !== state.hp[1]) { state.hp[1] = msg.hp1; updateHpBar(1); }
    if (msg.hp2 !== state.hp[2]) { state.hp[2] = msg.hp2; updateHpBar(2); }

    // Update posisi bola di DOM
    const b1 = document.getElementById('ball-p1');
    const b2 = document.getElementById('ball-p2');
    if (b1) { b1.style.left = state.pos[1].x + 'px'; b1.style.top = state.pos[1].y + 'px'; }
    if (b2) { b2.style.left = state.pos[2].x + 'px'; b2.style.top = state.pos[2].y + 'px'; }
  }

  // ===== HASIL PEMENANG dari HOST (authority) =====
  if (msg.type === 'game_result' && mpRole === 'guest') {
    // Host mengirim hasil akhir ‚Äî guest ikut hasil host
    if (!state.gameOver) {
      state.gameOver = true;
      cancelAnimationFrame(state.rafId);
    }
    if (msg.draw) {
      showDrawNotif();
    } else {
      endGame(msg.winner);
    }
  }
}

function checkBothCharReady() {
  if (mpHostChar && mpGuestChar) {
    if (mpRole === 'host') {
      // Host yang memulai battle dan memberi tahu guest
      mpSend({ type: 'start_battle', host_char: mpHostChar, guest_char: mpGuestChar });
      startMpBattle();
    }
    // Guest akan mulai saat menerima 'start_battle' dari host
  }
}

// =========== CREATE ROOM ===========
function createRoom() {
  const btn = document.getElementById('create-room-btn');
  btn.disabled = true;
  btn.textContent = 'MEMBUAT...';

  mpBattleStarted = false;
  mpHostChar = null;
  mpGuestChar = null;

  loadPeerJS(() => {
    // Buat peer dengan ID = kode room (6 karakter unik)
    const chars = 'abcdefghjklmnpqrstuvwxyz23456789';
    let code = 'bb-';
    for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
    mpRoomCode = code.replace('bb-', '').toUpperCase();

    try {
      mpPeer = new Peer('ballbattle-' + code.replace('bb-', ''), {
        host: '0.peerjs.com', port: 443, path: '/', secure: true,
        debug: 0
      });
    } catch(e) {
      btn.disabled = false;
      btn.textContent = 'BUAT ROOM';
      alert('Gagal membuat room: ' + e.message);
      return;
    }

    mpPeer.on('open', (id) => {
      mpRole = 'host';
      gameMode = 'multiplayer';
      document.getElementById('room-code-display').textContent = mpRoomCode;
      document.getElementById('room-code-box').classList.add('show');
      btn.textContent = 'ROOM DIBUAT ‚úì';
    });

    mpPeer.on('connection', (conn) => {
      if (mpConn) {
        // Tolak koneksi kedua
        conn.close();
        return;
      }
      mpConn = conn;
      conn.on('open', () => {
        // Beritahu guest bahwa koneksi berhasil, minta masuk select
        conn.send({ type: 'guest_ready' });
        enterMpSelect('host', mpRoomCode);
      });
      conn.on('data', onMpMessage);
      conn.on('close', () => { if (!mpBattleStarted) { mpConn = null; } });
      conn.on('error', (e) => console.error('conn error', e));
    });

    mpPeer.on('error', (err) => {
      console.error('PeerJS error:', err);
      if (err.type === 'unavailable-id') {
        // ID sudah dipakai, coba ulang
        if (mpPeer) { try { mpPeer.destroy(); } catch(e) {} mpPeer = null; }
        btn.disabled = false;
        btn.textContent = 'BUAT ROOM';
        createRoom();
      } else {
        btn.disabled = false;
        btn.textContent = 'BUAT ROOM';
      }
    });
  });
}

// =========== JOIN ROOM ===========
function joinRoom() {
  const input = document.getElementById('join-code-input');
  const code  = input.value.trim().toUpperCase();
  const errEl = document.getElementById('join-error');
  const btn   = document.getElementById('join-room-btn');

  if (code.length < 6) {
    errEl.textContent = 'Kode harus 6 karakter!';
    input.classList.add('error');
    setTimeout(() => input.classList.remove('error'), 600);
    return;
  }

  btn.disabled = true;
  btn.textContent = 'MENCARI...';
  errEl.textContent = '';

  mpBattleStarted = false;
  mpHostChar = null;
  mpGuestChar = null;

  loadPeerJS(() => {
    try {
      mpPeer = new Peer({
        host: '0.peerjs.com', port: 443, path: '/', secure: true,
        debug: 0
      });
    } catch(e) {
      errEl.textContent = 'Gagal membuat koneksi!';
      btn.disabled = false;
      btn.textContent = 'GABUNG';
      return;
    }

    mpPeer.on('open', () => {
      const hostPeerId = 'ballbattle-' + code.toLowerCase();
      mpConn = mpPeer.connect(hostPeerId, { reliable: true });

      const timeout = setTimeout(() => {
        if (!mpConn || !mpConn.open) {
          errEl.textContent = 'Room tidak ditemukan atau sudah penuh!';
          input.classList.add('error');
          setTimeout(() => input.classList.remove('error'), 600);
          btn.disabled = false;
          btn.textContent = 'GABUNG';
          if (mpPeer) { try { mpPeer.destroy(); } catch(e) {} mpPeer = null; }
          mpConn = null;
        }
      }, 8000);

      mpConn.on('open', () => {
        clearTimeout(timeout);
        mpRoomCode = code;
        mpRole = 'guest';
        gameMode = 'multiplayer';
        btn.disabled = false;
        btn.textContent = 'GABUNG';
        input.value = '';
        // Tunggu pesan 'guest_ready' dari host
      });

      mpConn.on('data', (msg) => {
        if (msg && msg.type === 'guest_ready') {
          // Konfirmasi ke host bahwa guest sudah terima
          mpConn.send({ type: 'guest_ack' });
          enterMpSelect('guest', mpRoomCode);
        } else {
          onMpMessage(msg);
        }
      });

      mpConn.on('close', () => { if (!mpBattleStarted) { mpConn = null; } });
      mpConn.on('error', (e) => {
        clearTimeout(timeout);
        errEl.textContent = 'Gagal terhubung ke room!';
        btn.disabled = false;
        btn.textContent = 'GABUNG';
      });
    });

    mpPeer.on('error', (err) => {
      console.error('PeerJS join error:', err);
      errEl.textContent = 'Room tidak ditemukan!';
      input.classList.add('error');
      setTimeout(() => input.classList.remove('error'), 600);
      btn.disabled = false;
      btn.textContent = 'GABUNG';
    });
  });
}

// =========== ENTER MP SELECT PAGE ===========
function enterMpSelect(role, code) {
  state.chars = { 1: null, 2: null };
  document.querySelectorAll('.char-card').forEach(c => {
    c.classList.remove(...UNSELECT_CLASSES);
    c.style.pointerEvents = '';
  });

  // Reset previews
  [1,2].forEach(p => {
    const e = document.getElementById('sp-emoji-p' + p); if (e) e.textContent = '‚ùì';
    const n = document.getElementById('sp-name-p' + p); if (n) { n.textContent = 'PILIH KARAKTER'; n.style.color = '#222'; }
    const d = document.getElementById('sp-desc-p' + p); if (d) d.innerHTML = '<span class="sp-char-placeholder">Sentuh karakter di bawah</span>';
    const t = document.getElementById('sp-tag-p' + p); if (t) t.textContent = '';
  });

  const badge = document.getElementById('mp-role-badge');
  const badgeWrap = document.getElementById('mp-role-badge-wrap');

  if (role === 'host') {
    // Host = Player 1 page
    badge.className = 'mp-role-badge host';
    badge.textContent = 'üè† HOST ‚Äî PLAYER 1';
    badgeWrap.style.display = '';
    document.querySelectorAll('#chars-p1 .char-card').forEach(c => { c.style.pointerEvents = ''; c.dataset.player = '1'; });
    // Show sp-confirm-p1 (links to mpConfirmChar via spConfirm)
    const b1 = document.getElementById('sp-confirm-p1'); if (b1) { b1.disabled = true; b1.textContent = 'KONFIRMASI'; }
    const mch = document.getElementById('mp-char-hint'); if (mch) mch.style.display = '';
    const mw = document.getElementById('mp-waiting-char'); if (mw) mw.classList.remove('show');
    showPage('select-p1');
  } else {
    // Guest = Player 2 page
    document.querySelectorAll('#chars-p2 .char-card').forEach(c => { c.style.pointerEvents = ''; c.dataset.player = '2'; });
    const b2 = document.getElementById('sp-confirm-p2'); if (b2) { b2.disabled = true; b2.textContent = 'KONFIRMASI'; }
    const mw2 = document.getElementById('mp-waiting-char-p2'); if (mw2) mw2.classList.remove('show');
    showPage('select-p2');
  }
}

// =========== MP CONFIRM CHAR ===========
function mpConfirmChar() {
  const myPlayer = mpRole === 'host' ? 1 : 2;
  const myChar = state.chars[myPlayer];
  if (!myChar) return;

  const myPlayerN = mpRole === 'host' ? 1 : 2;
  const spBtn = document.getElementById('sp-confirm-p' + myPlayerN);
  if (spBtn) { spBtn.disabled = true; spBtn.textContent = '‚úì TERKIRIM'; }
  const btn = document.getElementById('mp-char-confirm-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚úì DIKONFIRMASI'; }

  if (mpRole === 'host') {
    mpHostChar = myChar;
  } else {
    mpGuestChar = myChar;
  }

  // Kirim pilihan karakter ke peer
  mpSend({ type: 'char_selected', char: myChar });

  const myPN = mpRole === 'host' ? 1 : 2;
  const waitEl = myPN === 1
    ? document.getElementById('mp-waiting-char')
    : document.getElementById('mp-waiting-char-p2');
  if (waitEl) waitEl.classList.add('show');
  const mch2 = document.getElementById('mp-char-hint'); if (mch2) mch2.style.display = 'none';

  // Cek apakah keduanya sudah siap (misal keduanya memilih hampir bersamaan)
  checkBothCharReady();
}

function startMpBattle() {
  if (mpBattleStarted) return;
  mpBattleStarted = true;
  state.chars[1] = mpHostChar;
  state.chars[2] = mpGuestChar;
  ['mp-waiting-char','mp-waiting-char-p2'].forEach(id => {
    const el = document.getElementById(id); if (el) el.classList.remove('show');
  });
  startBattle();
}

// =========== CANCEL ROOM ===========
function cancelRoom() {
  if (mpPollInterval) { clearInterval(mpPollInterval); mpPollInterval = null; }
  mpBattleStarted = false;
  mpHostChar = null;
  mpGuestChar = null;

  if (mpConn) {
    try { mpConn.close(); } catch(e) {}
    mpConn = null;
  }
  if (mpPeer) {
    try { mpPeer.destroy(); } catch(e) {}
    mpPeer = null;
  }

  mpRoomCode = null;
  mpRole = null;
  gameMode = 'singleplayer';

  // Reset create room UI
  const btn = document.getElementById('create-room-btn');
  if (btn) { btn.disabled = false; btn.textContent = 'BUAT ROOM'; }
  const codeBox = document.getElementById('room-code-box');
  if (codeBox) codeBox.classList.remove('show');

  // Reset join UI
  const joinBtn = document.getElementById('join-room-btn');
  if (joinBtn) { joinBtn.disabled = false; joinBtn.textContent = 'GABUNG'; }
  const joinInput = document.getElementById('join-code-input');
  if (joinInput) joinInput.value = '';
  const joinErr = document.getElementById('join-error');
  if (joinErr) joinErr.textContent = '';

  // Reset select page
  document.querySelectorAll('.char-card').forEach(c => {
    c.classList.remove(...UNSELECT_CLASSES);
    c.style.pointerEvents = '';
  });
  document.querySelectorAll('#chars-p1 .char-card').forEach(c => c.dataset.player = '1');
  document.querySelectorAll('#chars-p2 .char-card').forEach(c => c.dataset.player = '2');
  state.chars = { 1: null, 2: null };
  // Reset previews
  [1,2].forEach(p => {
    const e = document.getElementById('sp-emoji-p' + p);
    const n = document.getElementById('sp-name-p' + p);
    const d = document.getElementById('sp-desc-p' + p);
    const t = document.getElementById('sp-tag-p' + p);
    if (e) e.textContent = '‚ùì';
    if (n) { n.textContent = 'PILIH KARAKTER'; n.style.color = '#222'; }
    if (d) d.innerHTML = '<span class="sp-char-placeholder">Sentuh karakter di bawah</span>';
    if (t) t.textContent = '';
  });
  // Reset confirm buttons
  const b1 = document.getElementById('sp-confirm-p1');
  const b2 = document.getElementById('sp-confirm-p2');
  if (b1) { b1.disabled = true; b1.textContent = 'KONFIRMASI'; }
  if (b2) { b2.disabled = true; b2.textContent = 'KONFIRMASI'; }

  const mw1 = document.getElementById('mp-waiting-char'); if (mw1) mw1.classList.remove('show');
  const mw2 = document.getElementById('mp-waiting-char-p2'); if (mw2) mw2.classList.remove('show');
  const ob1 = document.getElementById('opp-banner-p1'); if (ob1) ob1.classList.remove('show');
  const ob2 = document.getElementById('opp-banner-p2'); if (ob2) ob2.classList.remove('show');
  document.getElementById('mp-role-badge-wrap').style.display = 'none';
}


</script>
</body>
</html>
